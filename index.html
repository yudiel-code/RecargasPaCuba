<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

  <meta name="color-scheme" content="light">
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#28c6db">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#28c6db">
  <meta name="theme-color" content="#0b63d1">

  <title>RecargasPaCuba</title>
  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="styles/base.css">
  <link rel="stylesheet" href="styles/app.css">
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <script src="js/ui.js"></script>
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js').catch(err => {
          console.warn('SW registration failed:', err);
        });
      });
    }
  </script>
</head>

<body>

<main class="app">
  <section id="screen-home">
    <div class="login-wrap">

      <div class="logo-big">
        <img src="icon-256.png" alt="RecargasPaCuba logo">
      </div>

      <div class="login-title">Iniciar Sesión</div>

      <div class="login-sub">
        ¿Eres nuevo?
        <a id="link-register" href="registro.html" style="color:#fff7b8;font-weight:800;">
          Regístrate aquí
        </a>
      </div>

      <input id="login-identifier" class="input-pill" placeholder="Email / Usuario" />

      <div class="password-wrap">
        <input id="login-password" class="input-pill" placeholder="Contraseña" type="password" />
        <span id="toggle-pass" class="toggle-pass">👁</span>
      </div>

      <button id="btn-login-do" class="btn btn-primary btn-lg btn-full">Continuar</button>

      <button id="btn-forgot" class="link-forgot">¿Olvidaste tu contraseña?</button>

    </div>

    <div class="legal-links legal-links--sticky" style="text-align:center;margin-top:12px;">
      <small>
        <a href="terminos.html">Términos</a> ·
        <a href="privacidad.html">Privacidad</a> ·
        <a href="reembolsos.html">Reembolsos</a> ·
        <a href="mailto:recargaspacubaapp@gmail.com">Soporte</a>
      </small>
    </div>
  </section>
</main>

<div id="modal-recuperar" class="modal-bg-recuperar">
  <div class="modal-recuperar">
    <h2>Recuperar contraseña</h2>
    <input id="recuperar-email" type="email" class="input-pill" placeholder="Correo registrado" />
    <button id="btn-enviar-recuperar" class="btn btn-primary btn-lg btn-full" type="button">Enviar enlace</button>

    <div id="temp-pass-box" class="temp-pass-box"></div>
    <button id="btn-copiar-pass" class="btn-secondary" type="button" style="display:none;">
      Copiar y usar
    </button>

    <button id="btn-cerrar-recuperar" class="btn-secondary" type="button">Cancelar</button>
  </div>
</div>

<!-- SCRIPT PRINCIPAL LOGIN + RECUPERAR -->
<script type="module">
  // EmailJS (se deja inicializado por si se usa en otros flujos)
  emailjs.init("flObIaDu0VCKDBP7i");

  // B1.2: limpiar restos de contraseña / forzarCambio en localStorage
  (function limpiarSensibles() {
    try {
      const raw = localStorage.getItem("usuarioRegistrado") || "{}";
      const datos = JSON.parse(raw);
      if (datos && typeof datos === "object") {
        let cambiado = false;
        if (datos.pass) {
          delete datos.pass;
          cambiado = true;
        }
        if (datos.forzarCambio) {
          delete datos.forzarCambio;
          cambiado = true;
        }
        if (cambiado) {
          localStorage.setItem("usuarioRegistrado", JSON.stringify(datos));
        }
      }
    } catch (e) {
      console.error("Error limpiando usuarioRegistrado:", e);
    }
  })();

  const MAX_INTENTOS = 5;
  const BLOQUEO_TIEMPO = 10 * 60 * 1000;

  function estaBloqueado() {
    const bloqueo = localStorage.getItem("login_bloqueado_hasta");
    if (!bloqueo) return false;
    if (Date.now() > Number(bloqueo)) {
      localStorage.removeItem("login_bloqueado_hasta");
      localStorage.removeItem("login_intentos");
      return false;
    }
    return true;
  }

  async function loginConFirebase(email, pass) {
    if (!window.firebaseAuth || !window.firebaseSignIn) {
      throw new Error("firebase-no-disponible");
    }
    const cred = await window.firebaseSignIn(window.firebaseAuth, email, pass);
    return cred.user;
  }

  // LOGIN
  const btnLogin = document.getElementById("btn-login-do");
  if (btnLogin) {
    btnLogin.addEventListener("click", async () => {
      if (estaBloqueado()) {
        const hasta = new Date(Number(localStorage.getItem("login_bloqueado_hasta")));
        showToastError("🔒 Login bloqueado hasta: " + hasta.toLocaleTimeString());
        return;
      }

      const identifierRaw = document.getElementById("login-identifier").value.trim();
      const pass = document.getElementById("login-password").value.trim();

      if (!identifierRaw || !pass) {
        showToastError("Introduce email/usuario y contraseña.");
        return;
      }

      let identifier = identifierRaw.toLowerCase();

      // Mapear usuario → email si hace falta
      let emailLogin = identifier;
      if (!identifier.includes("@")) {
        try {
          const raw = localStorage.getItem("usuarioRegistrado") || "{}";
          const datos = JSON.parse(raw);
          if (datos && datos.usuario && datos.usuario.toLowerCase() === identifier) {
            emailLogin = (datos.email || "").toLowerCase();
          }
        } catch (e) {
          console.error("Error leyendo usuarioRegistrado para mapear usuario→email:", e);
        }
      }

      try {
        const user = await loginConFirebase(emailLogin, pass);

        // Reseteo de intentos
        localStorage.removeItem("login_intentos");
        localStorage.removeItem("login_bloqueado_hasta");

        // Sincronizar usuarioRegistrado SIN contraseña ni forzarCambio
        try {
          const rawPrev = localStorage.getItem("usuarioRegistrado") || "{}";
          let prev = {};
          try { prev = JSON.parse(rawPrev); } catch (e) { prev = {}; }
          if (!prev || typeof prev !== "object") prev = {};

          delete prev.pass;
          delete prev.forzarCambio;

          const usuarioMin = {
            ...prev,
            nombre: user.displayName || prev.nombre || "",
            email: (user.email || emailLogin).toLowerCase(),
            activo: true
          };
          localStorage.setItem("usuarioRegistrado", JSON.stringify(usuarioMin));
        } catch (e) {
          console.error("Error sincronizando datos locales tras login:", e);
        }

        localStorage.setItem("usuario", (user.email || emailLogin).toLowerCase());
        window.location.href = "recargar.html";
      } catch (error) {
        console.log("Error login Firebase:", error);

        let intentos = Number(localStorage.getItem("login_intentos")) || 0;
        intentos++;
        localStorage.setItem("login_intentos", intentos);

        if (intentos >= MAX_INTENTOS) {
          const bloqueoHasta = Date.now() + BLOQUEO_TIEMPO;
          localStorage.setItem("login_bloqueado_hasta", bloqueoHasta);
          showToastError("🔒 Demasiados intentos. Bloqueado 10 minutos.");
        } else {
          let mensaje = "Email o contraseña incorrectos.";
          if (error.code === "auth/user-not-found") {
            mensaje = "No existe una cuenta con ese email.";
          } else if (error.code === "auth/invalid-credential") {
            mensaje = "Credenciales incorrectas.";
          } else if (error.message === "firebase-no-disponible") {
            mensaje = "Servicio de login no disponible. Inténtalo de nuevo en unos minutos.";
          }
          showToastError(`${mensaje}\nIntentos: ${intentos}/${MAX_INTENTOS}`);
        }
      }
    });
  }

  // Ojito contraseña login
  const togglePass = document.getElementById("toggle-pass");
  if (togglePass) {
    togglePass.addEventListener("click", () => {
      const input = document.getElementById("login-password");
      const icon = document.getElementById("toggle-pass");
      if (!input || !icon) return;

      if (input.type === "password") {
        input.type = "text";
        icon.textContent = "🙈";
      } else {
        input.type = "password";
        icon.textContent = "👁";
      }
    });
  }

  // Abrir / cerrar modal recuperar
  const btnForgot = document.getElementById("btn-forgot");
  const modalRec = document.getElementById("modal-recuperar");
  const btnCerrarRec = document.getElementById("btn-cerrar-recuperar");

  if (btnForgot && modalRec) {
    btnForgot.onclick = () => {
      modalRec.style.display = "flex";
      const box = document.getElementById("temp-pass-box");
      const btnCopiar = document.getElementById("btn-copiar-pass");
      if (box) box.style.display = "none";
      if (btnCopiar) btnCopiar.style.display = "none";
    };
  }

  if (btnCerrarRec && modalRec) {
    btnCerrarRec.onclick = () => {
      modalRec.style.display = "none";
    };
  }

  // Recuperar contraseña con Firebase (sendPasswordResetEmail)
  const btnEnviarRec = document.getElementById("btn-enviar-recuperar");
  if (btnEnviarRec) {
    btnEnviarRec.onclick = async () => {
      const email = document.getElementById("recuperar-email").value.trim().toLowerCase();
      if (!email) {
        showToastError("Introduce el correo que usas en RecargasPaCuba.");
        return;
      }

      try {
        const firebaseModule = await import("./js/firebase.js");
        const auth = firebaseModule.auth || window.firebaseAuth || null;
        const sendPasswordResetEmail =
          firebaseModule.sendPasswordResetEmail ||
          firebaseModule.sendPasswordReset ||
          firebaseModule._sendPasswordResetEmail ||
          null;

        if (!auth || !sendPasswordResetEmail) {
          showToastError("De momento la recuperación por email aún no está configurada. Contacta con soporte.");
          return;
        }

        await sendPasswordResetEmail(auth, email);
        showToastSuccess("Si el correo está registrado, recibirás un email para restablecer tu contraseña.");
        if (modalRec) modalRec.style.display = "none";
      } catch (error) {
        console.error("Error al iniciar recuperación de contraseña:", error);
        let mensaje = "Error al iniciar la recuperación.";
        if (error.code === "auth/user-not-found") {
          mensaje = "No existe una cuenta con ese correo.";
        }
        showToastError(mensaje);
      }
    };
  }

  // El botón "copiar y usar" se deja sin comportamiento en el nuevo flujo
</script>

<!-- ✅ Firebase centralizado en js/firebase.js -->
<script type="module" src="js/firebase.js"></script>

<!-- ✅ B1.3: onAuthStateChanged en login para sincronizar sesión y redirigir -->
<script type="module">
  import { auth, onAuthStateChanged } from "./js/firebase.js";

  onAuthStateChanged(auth, (user) => {
    if (!user) return;

    try {
      const raw = localStorage.getItem("usuarioRegistrado") || "{}";
      const datos = JSON.parse(raw);

      const { pass, forzarCambio, ...resto } = (datos && typeof datos === "object") ? datos : {};

      const nuevo = {
        ...resto,
        nombre: resto.nombre || user.displayName || "",
        email: (user.email || "").toLowerCase(),
        activo: true
      };

      localStorage.setItem("usuarioRegistrado", JSON.stringify(nuevo));
      localStorage.setItem("usuario", (user.email || "").toLowerCase());

      // Si el usuario ya está autenticado en Firebase, lo mandamos directo a recargar
      window.location.href = "recargar.html";
    } catch (e) {
      console.error("Error sincronizando sesión en login:", e);
    }
  });
</script>
<script>
  const linkRegister = document.getElementById('link-register');
  if (linkRegister) {
    linkRegister.addEventListener('click', (event) => {
      event.preventDefault();
      window.location.href = 'registro.html';
    });
  }
</script>
</body>
</html>
