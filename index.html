<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

  <meta name="color-scheme" content="light">
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#28c6db">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#28c6db">
  <meta name="theme-color" content="#0b63d1">

  <title>RecargasPaCuba</title>
  <link rel="manifest" href="manifest.json">
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

  <!-- Anti-flash global -->
  <style>
    html, body {
      background: linear-gradient(180deg,#2fb8d6 0%, #2ba6d0 35%, #1aa0c3 70%) !important;
    }
    * { margin:0; padding:0; box-sizing:border-box; animation:none !important; transition:none !important; }
  </style>

  <style>
    html,body{
      height:100%;
      background: linear-gradient(180deg,#2fb8d6 0%, #2ba6d0 35%, #1aa0c3 70%);
    }

    body{
      font-family: Inter, system-ui, Arial, sans-serif;
      color:white;
      display:flex;
      flex-direction:column;
      min-height:100vh;
    }

    .app{
      flex:1;
      display:flex;
      flex-direction:column;
    }

    #screen-home {
      display:flex;
      align-items:flex-start;
      justify-content:center;
      min-height:100vh;
      background: linear-gradient(180deg,#2fb8d6 0%, #2ba6d0 35%, #1aa0c3 70%);
      padding-top:42px;
    }

    .login-wrap{
      width:100%;
      max-width:420px;
      text-align:center;
      color:#ffffff;
      padding:18px;
    }

    .logo-big{
      width:220px;
      height:220px;
      margin:0 auto 8px;
      border-radius:50%;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .logo-big img{
      width:90%;
      height:auto;
      border-radius:50%;
    }

    .login-title{
      font-size:40px;
      font-weight:800;
      margin-top:8px;
      color:#ffffff;
    }

    .login-sub{
      color:#e7f7fb;
      margin-top:8px;
      font-size:16px;
    }

    .input-pill{
      width:100%;
      border-radius:999px;
      padding:14px 18px;
      border:none;
      margin-top:18px;
      font-size:15px;
      outline:none;
      box-shadow:0 10px 26px rgba(0,0,0,0.22);
      color:#0f172a;
    }

    .password-wrap {
      position: relative;
      width: 100%;
    }

    .password-wrap .input-pill {
      padding-right: 46px;
    }

    .toggle-pass {
      position: absolute;
      right: 16px;
      top: 50%;
      transform: translateY(-50%);
      cursor: pointer;
      font-size: 18px;
      color: #0f172a;
      user-select: none;
    }

    .btn-primary-big{
      width:100%;
      margin-top:20px;
      border-radius:999px;
      padding:14px 16px;
      border:none;
      font-size:16px;
      font-weight:700;
      background:linear-gradient(135deg,#fed34c,#ffb13b);
      color:#0f172a;
      cursor:pointer;
      box-shadow:0 12px 28px rgba(0,0,0,0.28);
    }

    .link-forgot{
      background:none;
      border:none;
      color:#fff7b8;
      font-size:13px;
      text-decoration:underline;
      cursor:pointer;
      padding:0;
      margin-top:12px;
    }

    .modal-bg-recuperar {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 3000;
    }

    .modal-recuperar {
      background: rgba(11, 76, 129, 0.96);
      padding: 22px 20px;
      border-radius: 20px;
      width: 360px;
      text-align: center;
      color: #ffffff;
    }

    .btn-secondary {
      margin-top: 10px;
      padding: 10px 18px;
      border-radius: 999px;
      border: none;
      background: rgba(15,118,178,0.9);
      color: #e4f7ff;
      font-size: 14px;
      cursor: pointer;
    }

    .temp-pass-box{
      margin-top:12px;
      background:#0f345a;
      padding:10px;
      border-radius:12px;
      font-size:14px;
      display:none;
      word-break:break-all;
    }
  </style>
</head>

<body>

<main class="app">
  <section id="screen-home">
    <div class="login-wrap">

      <div class="logo-big">
        <img src="icon-256.png" alt="RecargasPaCuba logo">
      </div>

      <div class="login-title">Iniciar Sesi√≥n</div>

      <div class="login-sub">
        ¬øEres nuevo?
        <a href="registro.html" target="_blank" style="color:#fff7b8;font-weight:800;">
          Reg√≠strate aqu√≠
        </a>
      </div>

      <input id="login-identifier" class="input-pill" placeholder="Email / Usuario" />

      <div class="password-wrap">
        <input id="login-password" class="input-pill" placeholder="Contrase√±a" type="password" />
        <span id="toggle-pass" class="toggle-pass">üëÅ</span>
      </div>

      <button id="btn-login-do" class="btn-primary-big">Continuar</button>

      <button id="btn-forgot" class="link-forgot">¬øOlvidaste tu contrase√±a?</button>

    </div>
  </section>
</main>

<div id="modal-recuperar" class="modal-bg-recuperar">
  <div class="modal-recuperar">
    <h2>Recuperar contrase√±a</h2>
    <input id="recuperar-email" type="email" class="input-pill" placeholder="Correo registrado" />
    <button id="btn-enviar-recuperar" class="btn-primary-big" type="button">Enviar enlace</button>

    <div id="temp-pass-box" class="temp-pass-box"></div>
    <button id="btn-copiar-pass" class="btn-secondary" type="button" style="display:none;">
      Copiar y usar
    </button>

    <button id="btn-cerrar-recuperar" class="btn-secondary" type="button">Cancelar</button>
  </div>
</div>

<!-- SCRIPT PRINCIPAL LOGIN + RECUPERAR -->
<script type="module">
  // EmailJS (se deja inicializado por si se usa en otros flujos)
  emailjs.init("flObIaDu0VCKDBP7i");

  // B1.2: limpiar restos de contrase√±a / forzarCambio en localStorage
  (function limpiarSensibles() {
    try {
      const raw = localStorage.getItem("usuarioRegistrado") || "{}";
      const datos = JSON.parse(raw);
      if (datos && typeof datos === "object") {
        let cambiado = false;
        if (datos.pass) {
          delete datos.pass;
          cambiado = true;
        }
        if (datos.forzarCambio) {
          delete datos.forzarCambio;
          cambiado = true;
        }
        if (cambiado) {
          localStorage.setItem("usuarioRegistrado", JSON.stringify(datos));
        }
      }
    } catch (e) {
      console.error("Error limpiando usuarioRegistrado:", e);
    }
  })();

  const MAX_INTENTOS = 5;
  const BLOQUEO_TIEMPO = 10 * 60 * 1000;

  function estaBloqueado() {
    const bloqueo = localStorage.getItem("login_bloqueado_hasta");
    if (!bloqueo) return false;
    if (Date.now() > Number(bloqueo)) {
      localStorage.removeItem("login_bloqueado_hasta");
      localStorage.removeItem("login_intentos");
      return false;
    }
    return true;
  }

  async function loginConFirebase(email, pass) {
    if (!window.firebaseAuth || !window.firebaseSignIn) {
      throw new Error("firebase-no-disponible");
    }
    const cred = await window.firebaseSignIn(window.firebaseAuth, email, pass);
    return cred.user;
  }

  // LOGIN
  const btnLogin = document.getElementById("btn-login-do");
  if (btnLogin) {
    btnLogin.addEventListener("click", async () => {
      if (estaBloqueado()) {
        const hasta = new Date(Number(localStorage.getItem("login_bloqueado_hasta")));
        alert("üîí Login bloqueado hasta: " + hasta.toLocaleTimeString());
        return;
      }

      const identifierRaw = document.getElementById("login-identifier").value.trim();
      const pass = document.getElementById("login-password").value.trim();

      if (!identifierRaw || !pass) {
        alert("Introduce email/usuario y contrase√±a.");
        return;
      }

      let identifier = identifierRaw.toLowerCase();

      // Mapear usuario ‚Üí email si hace falta
      let emailLogin = identifier;
      if (!identifier.includes("@")) {
        try {
          const raw = localStorage.getItem("usuarioRegistrado") || "{}";
          const datos = JSON.parse(raw);
          if (datos && datos.usuario && datos.usuario.toLowerCase() === identifier) {
            emailLogin = (datos.email || "").toLowerCase();
          }
        } catch (e) {
          console.error("Error leyendo usuarioRegistrado para mapear usuario‚Üíemail:", e);
        }
      }

      try {
        const user = await loginConFirebase(emailLogin, pass);

        // Reseteo de intentos
        localStorage.removeItem("login_intentos");
        localStorage.removeItem("login_bloqueado_hasta");

        // Sincronizar usuarioRegistrado SIN contrase√±a ni forzarCambio
        try {
          const rawPrev = localStorage.getItem("usuarioRegistrado") || "{}";
          let prev = {};
          try { prev = JSON.parse(rawPrev); } catch (e) { prev = {}; }
          if (!prev || typeof prev !== "object") prev = {};

          delete prev.pass;
          delete prev.forzarCambio;

          const usuarioMin = {
            ...prev,
            nombre: user.displayName || prev.nombre || "",
            email: (user.email || emailLogin).toLowerCase(),
            activo: true
          };
          localStorage.setItem("usuarioRegistrado", JSON.stringify(usuarioMin));
        } catch (e) {
          console.error("Error sincronizando datos locales tras login:", e);
        }

        localStorage.setItem("usuario", (user.email || emailLogin).toLowerCase());
        window.location.href = "recargar.html";
      } catch (error) {
        console.log("Error login Firebase:", error);

        let intentos = Number(localStorage.getItem("login_intentos")) || 0;
        intentos++;
        localStorage.setItem("login_intentos", intentos);

        if (intentos >= MAX_INTENTOS) {
          const bloqueoHasta = Date.now() + BLOQUEO_TIEMPO;
          localStorage.setItem("login_bloqueado_hasta", bloqueoHasta);
          alert("üîí Demasiados intentos. Bloqueado 10 minutos.");
        } else {
          let mensaje = "Email o contrase√±a incorrectos.";
          if (error.code === "auth/user-not-found") {
            mensaje = "No existe una cuenta con ese email.";
          } else if (error.code === "auth/invalid-credential") {
            mensaje = "Credenciales incorrectas.";
          } else if (error.message === "firebase-no-disponible") {
            mensaje = "Servicio de login no disponible. Int√©ntalo de nuevo en unos minutos.";
          }
          alert(`${mensaje}\nIntentos: ${intentos}/${MAX_INTENTOS}`);
        }
      }
    });
  }

  // Ojito contrase√±a login
  const togglePass = document.getElementById("toggle-pass");
  if (togglePass) {
    togglePass.addEventListener("click", () => {
      const input = document.getElementById("login-password");
      const icon = document.getElementById("toggle-pass");
      if (!input || !icon) return;

      if (input.type === "password") {
        input.type = "text";
        icon.textContent = "üôà";
      } else {
        input.type = "password";
        icon.textContent = "üëÅ";
      }
    });
  }

  // Abrir / cerrar modal recuperar
  const btnForgot = document.getElementById("btn-forgot");
  const modalRec = document.getElementById("modal-recuperar");
  const btnCerrarRec = document.getElementById("btn-cerrar-recuperar");

  if (btnForgot && modalRec) {
    btnForgot.onclick = () => {
      modalRec.style.display = "flex";
      const box = document.getElementById("temp-pass-box");
      const btnCopiar = document.getElementById("btn-copiar-pass");
      if (box) box.style.display = "none";
      if (btnCopiar) btnCopiar.style.display = "none";
    };
  }

  if (btnCerrarRec && modalRec) {
    btnCerrarRec.onclick = () => {
      modalRec.style.display = "none";
    };
  }

  // Recuperar contrase√±a con Firebase (sendPasswordResetEmail)
  const btnEnviarRec = document.getElementById("btn-enviar-recuperar");
  if (btnEnviarRec) {
    btnEnviarRec.onclick = async () => {
      const email = document.getElementById("recuperar-email").value.trim().toLowerCase();
      if (!email) {
        alert("Introduce el correo que usas en RecargasPaCuba.");
        return;
      }

      try {
        const firebaseModule = await import("./js/firebase.js");
        const auth = firebaseModule.auth || window.firebaseAuth || null;
        const sendPasswordResetEmail =
          firebaseModule.sendPasswordResetEmail ||
          firebaseModule.sendPasswordReset ||
          firebaseModule._sendPasswordResetEmail ||
          null;

        if (!auth || !sendPasswordResetEmail) {
          alert("De momento la recuperaci√≥n por email a√∫n no est√° configurada. Contacta con soporte.");
          return;
        }

        await sendPasswordResetEmail(auth, email);
        alert("Si el correo est√° registrado, recibir√°s un email para restablecer tu contrase√±a.");
        if (modalRec) modalRec.style.display = "none";
      } catch (error) {
        console.error("Error al iniciar recuperaci√≥n de contrase√±a:", error);
        let mensaje = "Error al iniciar la recuperaci√≥n.";
        if (error.code === "auth/user-not-found") {
          mensaje = "No existe una cuenta con ese correo.";
        }
        alert(mensaje);
      }
    };
  }

  // El bot√≥n "copiar y usar" se deja sin comportamiento en el nuevo flujo
</script>

<!-- ‚úÖ Firebase centralizado en js/firebase.js -->
<script type="module" src="js/firebase.js"></script>

<!-- ‚úÖ B1.3: onAuthStateChanged en login para sincronizar sesi√≥n y redirigir -->
<script type="module">
  import { auth, onAuthStateChanged } from "./js/firebase.js";

  onAuthStateChanged(auth, (user) => {
    if (!user) return;

    try {
      const raw = localStorage.getItem("usuarioRegistrado") || "{}";
      const datos = JSON.parse(raw);

      const { pass, forzarCambio, ...resto } = (datos && typeof datos === "object") ? datos : {};

      const nuevo = {
        ...resto,
        nombre: resto.nombre || user.displayName || "",
        email: (user.email || "").toLowerCase(),
        activo: true
      };

      localStorage.setItem("usuarioRegistrado", JSON.stringify(nuevo));
      localStorage.setItem("usuario", (user.email || "").toLowerCase());

      // Si el usuario ya est√° autenticado en Firebase, lo mandamos directo a recargar
      window.location.href = "recargar.html";
    } catch (e) {
      console.error("Error sincronizando sesi√≥n en login:", e);
    }
  });
</script>

</body>
</html>
