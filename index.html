<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

  <meta name="color-scheme" content="light">
  <meta name="theme-color" content="#2fb8d6">

  <title>RecargasPaCuba</title>
  <link rel="manifest" href="manifest.json">
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

  <!-- Anti-flash global -->
  <style>
    html, body {
      background: linear-gradient(180deg,#2fb8d6 0%, #2ba6d0 35%, #1aa0c3 70%) !important;
      min-height: 100dvh;
      padding-top: env(safe-area-inset-top);
    }
    * { margin:0; padding:0; box-sizing:border-box; animation:none !important; transition:none !important; }
  </style>

  <style>
    html,body{
      min-height:100dvh;
      background: linear-gradient(180deg,#2fb8d6 0%, #2ba6d0 35%, #1aa0c3 70%);
    }

    body{
      font-family: Inter, system-ui, Arial, sans-serif;
      color:white;
      display:flex;
      flex-direction:column;
      min-height:100dvh;
      }

   .app{
  flex:1;
  display:flex;
  flex-direction:column;
  background: linear-gradient(180deg,#2fb8d6 0%, #2ba6d0 35%, #1aa0c3 70%);
  background-color:#2fb8d6;
}


    #screen-home {
      display:flex;
      align-items:flex-start;
      justify-content:center;
      min-height:100dvh;
      background: linear-gradient(180deg,#2fb8d6 0%, #2ba6d0 35%, #1aa0c3 70%);
      padding-top:0;
    }

    .login-wrap{
      width:100%;
      max-width:420px;
      text-align:center;
      color:#ffffff;
      padding:18px;
      margin-top:42px;
    }

    .logo-big{
      width:220px;
      height:220px;
      margin:0 auto 8px;
      border-radius:50%;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .logo-big img{
      width:90%;
      height:auto;
      border-radius:50%;
    }

    .login-title{
      font-size:40px;
      font-weight:800;
      margin-top:8px;
      color:#ffffff;
    }

    .login-sub{
      color:#e7f7fb;
      margin-top:8px;
      font-size:16px;
    }

    .input-pill{
      width:100%;
      border-radius:999px;
      padding:14px 18px;
      border:none;
      margin-top:18px;
      font-size:15px;
      outline:none;
      box-shadow:0 10px 26px rgba(0,0,0,0.22);
      color:#0f172a;
    }

    .password-wrap {
      position: relative;
      width: 100%;
    }

    .password-wrap .input-pill {
      padding-right: 46px;
    }

    .toggle-pass {
      position: absolute;
      right: 16px;
      top: 50%;
      transform: translateY(-50%);
      cursor: pointer;
      font-size: 18px;
      color: #0f172a;
      user-select: none;
    }

    .btn-primary-big{
      width:100%;
      margin-top:20px;
      border-radius:999px;
      padding:14px 16px;
      border:none;
      font-size:16px;
      font-weight:700;
      background:linear-gradient(135deg,#fed34c,#ffb13b);
      color:#0f172a;
      cursor:pointer;
      box-shadow:0 12px 28px rgba(0,0,0,0.28);
    }

    .link-forgot{
      background:none;
      border:none;
      color:#fff7b8;
      font-size:13px;
      text-decoration:underline;
      cursor:pointer;
      padding:0;
      margin-top:12px;
    }

    .modal-bg-recuperar {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 3000;
    }

    .modal-recuperar {
      background: rgba(11, 76, 129, 0.96);
      padding: 22px 20px;
      border-radius: 20px;
      width: 360px;
      text-align: center;
      color: #ffffff;
    }

    .btn-secondary {
      margin-top: 10px;
      padding: 10px 18px;
      border-radius: 999px;
      border: none;
      background: rgba(15,118,178,0.9);
      color: #e4f7ff;
      font-size: 14px;
      cursor: pointer;
    }

    .temp-pass-box{
      margin-top:12px;
      background:#0f345a;
      padding:10px;
      border-radius:12px;
      font-size:14px;
      display:none;
      word-break:break-all;
    }
  </style>
</head>

<body>

<main class="app">
  <section id="screen-home">
    <div class="login-wrap">

      <div class="logo-big">
        <img src="icon-256.png" alt="RecargasPaCuba logo">
      </div>

      <div class="login-title">Iniciar Sesi√≥n</div>

      <div class="login-sub">
        ¬øEres nuevo?
        <a href="registro.html" target="_blank" style="color:#fff7b8;font-weight:800;">
          Reg√≠strate aqu√≠
        </a>
      </div>

      <input id="login-identifier" class="input-pill" placeholder="Email / Usuario" />

      <div class="password-wrap">
        <input id="login-password" class="input-pill" placeholder="Contrase√±a" type="password" />
        <span id="toggle-pass" class="toggle-pass">üëÅ</span>
      </div>

      <button id="btn-login-do" class="btn-primary-big">Continuar</button>

      <button id="btn-forgot" class="link-forgot">¬øOlvidaste tu contrase√±a?</button>

    </div>
  </section>
</main>

<div id="modal-recuperar" class="modal-bg-recuperar">
  <div class="modal-recuperar">
    <h2>Recuperar contrase√±a</h2>
    <input id="recuperar-email" type="email" class="input-pill" placeholder="Correo registrado" />
    <button id="btn-enviar-recuperar" class="btn-primary-big" type="button">Generar contrase√±a</button>

    <div id="temp-pass-box" class="temp-pass-box"></div>
    <button id="btn-copiar-pass" class="btn-secondary" type="button" style="display:none;">
      Copiar y usar
    </button>

    <button id="btn-cerrar-recuperar" class="btn-secondary" type="button">Cancelar</button>
  </div>
</div>

<script>
  // ‚úÖ EmailJS
  emailjs.init("flObIaDu0VCKDBP7i");

  // Si ya hay sesi√≥n iniciada, ir a recargar
  if (localStorage.getItem("usuario")) {
    window.location.href = "recargar.html";
  }

  // ‚úÖ Generar contrase√±a temporal
  function generarPasswordTemporal(){
    const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
    let pass = "";
    for(let i=0;i<8;i++){
      pass += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return pass;
  }

  const MAX_INTENTOS = 5;
  const BLOQUEO_TIEMPO = 10 * 60 * 1000;

  function estaBloqueado(){
    const bloqueo = localStorage.getItem("login_bloqueado_hasta");
    if(!bloqueo) return false;
    if(Date.now() > Number(bloqueo)){
      localStorage.removeItem("login_bloqueado_hasta");
      localStorage.removeItem("login_intentos");
      return false;
    }
    return true;
  }

  // ‚úÖ LOGIN
  document.getElementById("btn-login-do").addEventListener("click", () => {

    if(estaBloqueado()){
      const hasta = new Date(Number(localStorage.getItem("login_bloqueado_hasta")));
      alert("üîí Login bloqueado hasta: " + hasta.toLocaleTimeString());
      return;
    }

    const identifier = document.getElementById("login-identifier").value.trim().toLowerCase();
    const pass = document.getElementById("login-password").value.trim();

    const data = localStorage.getItem("usuarioRegistrado");
    if (!data) {
      alert("Debes registrarte primero.");
      return;
    }

    const usuario = JSON.parse(data);

    const coincide =
      (usuario.email && usuario.email.toLowerCase() === identifier) ||
      (usuario.usuario && usuario.usuario.toLowerCase() === identifier);

    if (coincide && usuario.pass === pass) {

      if(usuario.forzarCambio){
        localStorage.setItem("usuario", identifier);
        window.location.href = "cambiar-password.html";
        return;
      }

      localStorage.removeItem("login_intentos");
      localStorage.removeItem("login_bloqueado_hasta");
      localStorage.setItem("usuario", identifier);
      window.location.href = "recargar.html";

    } else {
      let intentos = Number(localStorage.getItem("login_intentos")) || 0;
      intentos++;
      localStorage.setItem("login_intentos", intentos);

      if(intentos >= MAX_INTENTOS){
        const bloqueoHasta = Date.now() + BLOQUEO_TIEMPO;
        localStorage.setItem("login_bloqueado_hasta", bloqueoHasta);
        alert("üîí Demasiados intentos. Bloqueado 10 minutos.");
      } else {
        alert(`Email, usuario o contrase√±a incorrectos.\nIntentos: ${intentos}/${MAX_INTENTOS}`);
      }
    }
  });

  // ‚úÖ Ojito contrase√±a login
  document.getElementById("toggle-pass").addEventListener("click", () => {
    const input = document.getElementById("login-password");
    const icon = document.getElementById("toggle-pass");
    if (input.type === "password") {
      input.type = "text";
      icon.textContent = "üôà";
    } else {
      input.type = "password";
      icon.textContent = "üëÅ";
    }
  });

  // ‚úÖ Abrir / cerrar modal recuperar
  document.getElementById("btn-forgot").onclick = () => {
    document.getElementById("modal-recuperar").style.display = "flex";
    document.getElementById("temp-pass-box").style.display = "none";
    document.getElementById("btn-copiar-pass").style.display = "none";
  };

  document.getElementById("btn-cerrar-recuperar").onclick = () => {
    document.getElementById("modal-recuperar").style.display = "none";
  };

  // ‚úÖ Generar contrase√±a temporal + enviar email + mostrar
  document.getElementById("btn-enviar-recuperar").onclick = () => {
    const email = document.getElementById("recuperar-email").value.trim().toLowerCase();
    const data = localStorage.getItem("usuarioRegistrado");

    if (!data) {
      alert("No hay usuario registrado.");
      return;
    }

    const usuario = JSON.parse(data);

    if (usuario.email !== email) {
      alert("Ese correo no est√° registrado.");
      return;
    }

    const nuevaPass = generarPasswordTemporal();
    usuario.pass = nuevaPass;
    usuario.forzarCambio = true;

    localStorage.setItem("usuarioRegistrado", JSON.stringify(usuario));

    const box = document.getElementById("temp-pass-box");
    box.style.display = "block";
    box.textContent = "Contrase√±a temporal: " + nuevaPass;

    document.getElementById("btn-copiar-pass").style.display = "inline-block";

    // ‚úÖ Mandamos varias variables por si el template usa nombres distintos
    emailjs.send(
      "service_ryvafj3",
      "template_jd0km4e",
      {
        to_email: usuario.email,
        email: usuario.email,
        temp_pass: nuevaPass,
        new_password: nuevaPass,
        nombre: usuario.nombre || usuario.usuario || ""
      },
      "flObIaDu0VCKDBP7i"
    ).then(function() {
      console.log("Email de recuperaci√≥n enviado");
    }, function(error) {
      console.log("Error env√≠o EmailJS:", error);
    });
  };

  // ‚úÖ Copiar Y PEGAR autom√°tico en el login
  document.getElementById("btn-copiar-pass").onclick = () => {
    const texto = document.getElementById("temp-pass-box")
      .textContent.replace("Contrase√±a temporal: ", "").trim();

    // Pegamos en el input de login SIEMPRE
    document.getElementById("login-password").value = texto;

    // Intentamos copiar al portapapeles (si el navegador lo permite)
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(texto).catch(() => {});
    }

    // Cerramos el modal
    document.getElementById("modal-recuperar").style.display = "none";
  };
</script>

</body>
</html>
