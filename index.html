<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RecargasPaCuba</title>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0d63c9">

  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family: Inter, system-ui, Arial, sans-serif;
      background:#0b0f13;
      color:white;
      display:flex;
      flex-direction:column;
      min-height:100vh;
    }
    .app{max-width:820px;margin:auto;width:100%;padding:16px;flex:1 0 auto}

    header.appbar{
      background: linear-gradient(
        to bottom right,
        rgba(0,91,187,0.85),
        rgba(255,255,255,0.18),
        rgba(206,17,38,0.85)
      );
      padding:18px 22px;
      text-align:center;
      border-bottom-left-radius:12px;
      border-bottom-right-radius:12px;
    }
    header.appbar h1{font-size:20px;font-weight:800;}
    header.appbar .greeting{margin-top:6px;font-size:13px;color:#ffffffc9;font-weight:600}

    nav.bottom{
      position:sticky;bottom:0;
      display:flex;justify-content:space-around;
      padding:10px;
      background:rgba(255,255,255,0.08);
      border-top-left-radius:16px;
      border-top-right-radius:16px;
      backdrop-filter:blur(8px)
    }
    .nav-btn{cursor:pointer;font-size:12px;text-align:center;color:white}
    .nav-btn.active{font-weight:800}

    .home-screen{text-align:center;padding:20px}

    .card{
      background:rgba(255,255,255,0.06);
      padding:16px;border-radius:12px;
      margin:20px auto 0;
      max-width:460px;
    }
    input{
      width:100%;
      padding:10px 12px;
      border-radius:8px;
      border:none;
      background:rgba(0,0,0,0.35);
      color:white;
    }
    .field{
      position:relative;
      margin-bottom:10px;
    }
    .eye-toggle{
      position:absolute;
      right:10px;
      top:50%;
      transform:translateY(-50%);
      cursor:pointer;
      font-size:14px;
      color:#cbd5e1;
    }

    .btn-primary{
      background:#0d63c9;
      border:none;
      color:white;
      padding:10px 14px;
      border-radius:10px;
      font-weight:700;
      cursor:pointer;
      width:100%;
    }
    .btn-tertiary{
      margin-top:10px;
      background:transparent;
      border:1px solid rgba(255,255,255,0.15);
      color:#cbd5e1;
      padding:10px;
      border-radius:8px;
      cursor:pointer;
      width:100%;
    }
    .btn-logout-global{
      background:#b00020;
      border:none;
      color:white;
      padding:12px;
      width:86%;
      margin:20px auto 70px;
      display:block;
      border-radius:12px;
      font-weight:700;
      text-align:center;
      cursor:pointer;
    }
    .saldo-box{
      background:rgba(255,255,255,0.06);
      padding:20px;
      border-radius:12px;margin-bottom:20px;text-align:center
    }
    .saldo-monto{font-weight:800;font-size:26px;margin-top:5px}

    .promo-banner{
      margin:12px 0;
      padding:12px;
      background:linear-gradient(90deg,#ffefc2,#ffd27a);
      color:#2b2b2b;
      border-radius:10px;
      font-weight:700;
    }

    .offer-card{
      background:rgba(255,255,255,0.06);
      padding:12px;
      border-radius:12px;
      margin-bottom:12px;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .logo-cubacel,.logo-nauta{
      width:60px;height:60px;
      border-radius:10px;
      display:flex;justify-content:center;align-items:center;
      color:white;font-weight:800;
    }
    .logo-cubacel{background:#005bbb}
    .logo-nauta{background:#bb001b}

    .btn-buy{
      background:#0d63c9;border:none;padding:8px 12px;color:white;border-radius:8px;font-weight:700;cursor:pointer;
    }
  #modal-bg {
    display: none !important;
  }  
  </style>
</head>

<body>
<header class="appbar">
  <h1>RecargasPaCuba</h1>
  <div id="header-greeting"></div>
</header>

<main class="app">

  <!-- HOME -->
  <section id="screen-home" style="display:none" class="home-screen">
    <h2 id="home-title">Bienvenido</h2>
    <p id="home-sub" style="color:#c9d3df;margin-top:8px;"></p>

    <!-- TARJETA LOGIN / REGISTRO -->
    <div class="card" id="auth-card">

      <!-- LOGIN -->
      <div id="login-form">
        <h3>Iniciar sesi√≥n</h3>

        <!-- CAMPO IDENTIFICADOR NUEVO ESTILO -->
        <div class="field">
          <input id="login-identifier" placeholder="Usuario o correo">
        </div>

        <!-- CONTRASE√ëA CON OJITO -->
        <div class="field">
          <input id="login-password" type="password" placeholder="Contrase√±a">
          <span class="eye-toggle" data-target="login-password">üëÅ</span>
        </div>

        <button id="btn-login-do" class="btn-primary">Entrar</button>
      </div>

      <!-- BOT√ìN REGISTRARSE ABAJO -->
      <button id="btn-show-register" class="btn-tertiary">Registrarse</button>

      <!-- REGISTRO -->
      <div id="register-form" style="display:none;margin-top:12px">
        <h3>Crear cuenta</h3>

        <div class="field">
          <input id="reg-username" placeholder="Nombre de usuario (opcional)">
        </div>

        <div class="field">
          <input id="reg-email" type="email" placeholder="Correo electr√≥nico (opcional)">
        </div>

        <div class="field">
          <input id="reg-phone" type="tel" placeholder="Tel√©fono (opcional)">
        </div>

        <!-- CONTRASE√ëA 1 -->
        <div class="field">
          <input id="reg-password" type="password" placeholder="Contrase√±a (obligatoria)">
          <span class="eye-toggle" data-target="reg-password">üëÅ</span>
        </div>

        <!-- CONTRASE√ëA 2 (REPETIR) -->
        <div class="field">
          <input id="reg-password2" type="password" placeholder="Repetir contrase√±a">
          <span class="eye-toggle" data-target="reg-password2">üëÅ</span>
        </div>

        <button id="btn-register-do" class="btn-primary">Crear cuenta</button>
        <button id="btn-cancel-register" class="btn-tertiary">Volver</button>
      </div>

    </div>
  </section>
  <!-- RECARGAR -->
  <section id="screen-recargar" style="display:none">

    <div id="promo-container" style="display:none">
      <div id="promo-banner" class="promo-banner"></div>
    </div>

    <div class="tabs" style="display:flex;gap:8px;justify-content:center;margin-bottom:14px">
      <button class="tab-btn active" id="tab-cubacel">CUBACEL</button>
      <button class="tab-btn" id="tab-nauta">NAUTA</button>
    </div>

    <div id="offers-list"></div>
  </section>

  <!-- HISTORIAL -->
  <section id="screen-historial" style="display:none">
    <div style="padding:20px;text-align:center;color:#cbd5e1">Historial vac√≠o (demo)</div>
  </section>

  <!-- CUENTA -->
  <section id="screen-cuenta" style="display:none">
    <div class="saldo-box">
      <div>Saldo disponible</div>
      <div id="saldo-monto" class="saldo-monto">0.00 EUR</div>
      <button id="btn-agregar-saldo" class="btn-primary" style="max-width:260px;margin-top:12px">Agregar saldo</button>
    </div>

    <!-- PERFIL -->
    <div class="card" id="profile-card" style="display:none">
      <h3>Perfil</h3>
      <div id="profile-username" style="font-weight:700;margin-bottom:6px"></div>
      <div id="profile-email" style="color:#cbd5e1;margin-bottom:6px"></div>
      <div id="profile-phone" style="color:#cbd5e1;margin-bottom:10px"></div>

      <div style="margin-top:12px;color:#cbd5e1;text-align:left">M√©todos de pago guardados (demo)</div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="btn-tertiary" id="pay-bizum">Bizum</button>
        <button class="btn-tertiary" id="pay-card">Tarjeta</button>
        <button class="btn-tertiary" id="pay-paypal">PayPal</button>
      </div>
    </div>

    <!-- BOT√ìN GLOBAL DE CERRAR SESI√ìN (NUEVO) -->
    <button id="btn-logout-global" class="btn-logout-global" style="display:none">
      Cerrar sesi√≥n
    </button>

  </section>
</main>

<!-- NAV -->
<nav class="bottom">
  <div class="nav-btn" id="nav-home">Inicio</div>
  <div class="nav-btn active" id="nav-recargar">Recargar</div>
  <div class="nav-btn" id="nav-historial">Historial</div>
  <div class="nav-btn" id="nav-cuenta">Cuenta</div>
</nav>

<script>
/* -----------------------------
   SERVICE WORKER
------------------------------ */
if ('serviceWorker' in navigator) navigator.serviceWorker.register('service-worker.js');

/* -----------------------------
      VARIABLES GLOBALES
------------------------------ */
const STORAGE_KEY = "rpc_user";
const headerGreeting = document.getElementById("header-greeting");
const homeTitle = document.getElementById("home-title");
const homeSub = document.getElementById("home-sub");

const loginForm = document.getElementById("login-form");
const registerForm = document.getElementById("register-form");
const btnShowRegister = document.getElementById("btn-show-register");
const btnCancelRegister = document.getElementById("btn-cancel-register");

const loginIdentifier = document.getElementById("login-identifier");
const loginPassword = document.getElementById("login-password");
const btnLoginDo = document.getElementById("btn-login-do");

const regUsername = document.getElementById("reg-username");
const regEmail = document.getElementById("reg-email");
const regPhone = document.getElementById("reg-phone");
const regPassword = document.getElementById("reg-password");
const regPassword2 = document.getElementById("reg-password2");
const btnRegisterDo = document.getElementById("btn-register-do");

const profileCard = document.getElementById("profile-card");
const profileUsername = document.getElementById("profile-username");
const profileEmail = document.getElementById("profile-email");
const profilePhone = document.getElementById("profile-phone");
const btnLogoutGlobal = document.getElementById("btn-logout-global");

let saldo = 0;
const saldoMonto = document.getElementById("saldo-monto");
const btnAgregarSaldo = document.getElementById("btn-agregar-saldo");
const modalBG = document.getElementById("modal-bg");
  /* -----------------------------
      OJO PARA VER/OCULTAR
------------------------------ */
document.querySelectorAll(".eye-toggle").forEach(eye=>{
  eye.addEventListener("click", ()=>{
    const targetId = eye.getAttribute("data-target");
    const input = document.getElementById(targetId);
    if(input.type === "password"){
      input.type = "text";
      eye.textContent = "üôà";
    } else {
      input.type = "password";
      eye.textContent = "üëÅ";
    }
  });
});

/* -----------------------------
        LOCAL STORAGE
------------------------------ */
function saveUser(obj){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(obj));
}
function getUser(){
  const raw = localStorage.getItem(STORAGE_KEY);
  return raw ? JSON.parse(raw) : null;
}
function clearUser(){
  localStorage.removeItem(STORAGE_KEY);
}

/* Usuario autom√°tico desde correo */
function autoUsernameFromEmail(email){
  if(!email) return "";
  return email.split("@")[0].replace(/[^a-zA-Z0-9_\-]/g,"").toLowerCase();
}

/* -----------------------------
       ACTUALIZAR UI
------------------------------ */
function updateUIForUser(user){
  if(user){
    const name = user.username || autoUsernameFromEmail(user.email) || "Usuario";

    headerGreeting.textContent = `Hola, ${name} üëã`;
    homeTitle.textContent = `Hola, ${name} üëã`;
    homeSub.textContent = "Listo para enviar recargas";

    loginForm.style.display = "none";
    registerForm.style.display = "none";
    btnShowRegister.style.display = "none";

    profileCard.style.display = "block";
    btnLogoutGlobal.style.display = "block";

    profileUsername.textContent = user.username ? `@${user.username}` : "(sin usuario)";
    profileEmail.textContent    = user.email ? `‚úâ ${user.email}` : "";
    profilePhone.textContent    = user.phone ? `üìû ${user.phone}` : "";

  } else {
    headerGreeting.textContent = "";
    homeTitle.textContent = "Bienvenido";
    homeSub.textContent = "Accede con tu cuenta para continuar";

    loginForm.style.display = "";
    registerForm.style.display = "none";
    btnShowRegister.style.display = "";
    profileCard.style.display = "none";
    btnLogoutGlobal.style.display = "none";
  }
}

/* -----------------------------
           REGISTRO
------------------------------ */
btnShowRegister.addEventListener("click", ()=>{
  loginForm.style.display = "none";
  registerForm.style.display = "";
});

btnCancelRegister.addEventListener("click", ()=>{
  registerForm.style.display = "none";
  loginForm.style.display = "";
});

btnRegisterDo.addEventListener("click", ()=>{
  const username = regUsername.value.trim();
  const email    = regEmail.value.trim();
  const phone    = regPhone.value.trim();
  const pass1    = regPassword.value;
  const pass2    = regPassword2.value;

  if(pass1.length < 6){
    alert("La contrase√±a debe tener al menos 6 caracteres.");
    return;
  }
  if(pass1 !== pass2){
    alert("Las contrase√±as no coinciden.");
    return;
  }
  if(!username && !email){
    alert("Debes ingresar un usuario o un correo (m√≠nimo uno).");
    return;
  }

  let finalUsername = username;
  if(!finalUsername && email){
    finalUsername = autoUsernameFromEmail(email);
  }

  const userObj = {
    username: finalUsername || null,
    email: email || null,
    phone: phone || null,
    password: pass1,
    created: Date.now()
  };

  saveUser(userObj);
  updateUIForUser(userObj);
  alert("Cuenta creada correctamente.");
  show("home");
});

/* -----------------------------
             LOGIN
------------------------------ */
btnLoginDo.addEventListener("click", ()=>{
  const id  = loginIdentifier.value.trim();
  const pwd = loginPassword.value;

  if(!id || !pwd){
    alert("Introduce tus datos.");
    return;
  }

  const user = getUser();
  if(!user){
    alert("No existe ninguna cuenta registrada.");
    return;
  }

  const isUser =
    (user.username && id === user.username) ||
    (user.email && id.toLowerCase() === user.email.toLowerCase());

  if(isUser && pwd === user.password){
    updateUIForUser(user);
    alert("Sesi√≥n iniciada.");
    show("home");
  } else {
    alert("Usuario/correo o contrase√±a incorrectos.");
  }
});

/* -----------------------------
       CERRAR SESI√ìN GLOBAL
------------------------------ */
btnLogoutGlobal.addEventListener("click", ()=>{
  if(confirm("¬øCerrar sesi√≥n?")){
    clearUser();
    updateUIForUser(null);
    show("home");
  }
});

/* -----------------------------
            SALDO
------------------------------ */
btnAgregarSaldo.addEventListener("click", ()=>{
  modalBG.style.display = "flex";
});

document.getElementById("cerrar-modal").addEventListener("click", ()=>{
  modalBG.style.display = "none";
});

document.querySelectorAll(".pago-btn[data-metodo]").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    saldo += 10;
    saldoMonto.textContent = saldo.toFixed(2) + " EUR";
    modalBG.style.display = "none";
    alert("Saldo agregado (demo)");
  });
});

/* -----------------------------
           OFERTAS
------------------------------ */
const CUBACEL = [
  {title:"EUR 10,42 ‚Äî Recarga m√≠nima", details:"Recarga m√≠nima v√°lida"},
  {title:"EUR 20,84 ‚Äî Recarga 500 CUP + bonus", details:"Promo con bonus y datos"},
  {title:"EUR 25,01 ‚Äî Recarga 600 CUP + pack", details:"Pack combinado"},
  {title:"EUR 29,18 ‚Äî Recarga 700 CUP + datos", details:"Pack + datos"},
  {title:"EUR 31,26 ‚Äî 10GB (solo 4G)", details:"Datos + minutos"},
  {title:"EUR 41,68 ‚Äî 16GB solo 4G", details:"Datos para 30 d√≠as"},
  {title:"EUR 21,98 ‚Äî Paquete especial", details:"Paquete y minutos"},
  {title:"EUR 65,93 ‚Äî Modem data 50GB", details:"Datos para dispositivos"}
];

const NAUTA = [
  {title:"EUR 8,12 ‚Äî Nauta Plus (15 d√≠as)", details:"Acceso Nauta Plus 15D"},
  {title:"EUR 13,53 ‚Äî Nauta Plus (30 d√≠as)", details:"Acceso Nauta Plus 30D"},
  {title:"EUR 10,46 ‚Äî NAUTA m√≠nima", details:"Recarga NAUTA m√≠nima"},
  {title:"EUR 52,20 ‚Äî NAUTA Max", details:"Recarga NAUTA m√°xima"}
];

function userLogged(){
  return !!getUser();
}

function renderOffers(type){
  const list = type === "CUBACEL" ? CUBACEL : NAUTA;
  const offers = document.getElementById("offers-list");
  offers.innerHTML = "";

  list.forEach((o,i)=>{
    const price = (o.title.match(/EUR\s?[0-9.,]+/)||[""])[0];
    offers.innerHTML += `
      <div class="offer-card">
        <div style="display:flex;gap:12px;align-items:center">
          <div class="${type==="CUBACEL" ? "logo-cubacel" : "logo-nauta"}">
            ${type==="CUBACEL"?"CU":"NA"}
          </div>
          <div>
            <div>${o.title}</div>
            <div style="color:#cbd5e1;font-size:13px">${o.details}</div>
          </div>
        </div>
        <div style="text-align:right">
          <div style="font-weight:700">${price}</div>
          <button class="btn-buy" data-type="${type}" data-index="${i}">
            ${userLogged() ? "Comprar" : "Entrar para comprar"}
          </button>
        </div>
      </div>
    `;
  });

  document.querySelectorAll(".btn-buy").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      if(!userLogged()){
        alert("Debes iniciar sesi√≥n para comprar.");
        show("home");
        return;
      }
      const idx = btn.dataset.index;
      const sel = (type === "CUBACEL" ? CUBACEL : NAUTA)[idx];
      alert("Comprar (demo): " + sel.title);
    });
  });
}

/* TABS */
document.getElementById("tab-cubacel").onclick = ()=>{
  document.getElementById("tab-cubacel").classList.add("active");
  document.getElementById("tab-nauta").classList.remove("active");
  renderOffers("CUBACEL");
};

document.getElementById("tab-nauta").onclick = ()=>{
  document.getElementById("tab-nauta").classList.add("active");
  document.getElementById("tab-cubacel").classList.remove("active");
  renderOffers("NAUTA");
};

/* -----------------------------
      NAVEGACI√ìN
------------------------------ */
function show(screen){
  document.querySelectorAll("main section").forEach(s=>s.style.display="none");
  document.querySelectorAll(".nav-btn").forEach(b=>b.classList.remove("active"));

  document.getElementById("screen-"+screen).style.display = "block";
  document.getElementById("nav-"+screen).classList.add("active");

  if(screen==="recargar"){
    const activeTab = document.querySelector(".tab-btn.active");
    const type = activeTab.id==="tab-nauta" ? "NAUTA" : "CUBACEL";
    renderOffers(type);
  }

  if(screen==="cuenta"){
    const user = getUser();
    if(user){
      profileCard.style.display = "block";
      btnLogoutGlobal.style.display = "block";
    } else {
      profileCard.style.display = "none";
      btnLogoutGlobal.style.display = "none";
    }
  }
}

document.getElementById("nav-home").onclick     = ()=> show("home");
document.getElementById("nav-recargar").onclick = ()=> show("recargar");
document.getElementById("nav-historial").onclick= ()=> show("historial");
document.getElementById("nav-cuenta").onclick   = ()=> show("cuenta");

/* -----------------------------
        INICIO APP
------------------------------ */
const existing = getUser();
if(existing) updateUIForUser(existing);

renderOffers("CUBACEL");
show("home");
</script>

 <!-- MODAL SALDO -->
<div id="modal-bg" class="modal-bg" aria-hidden="true">
  <div class="modal">
    <div style="margin-bottom:10px;font-weight:700">Agregar saldo</div>
    <button class="pago-btn" data-metodo="Bizum">Bizum</button>
    <button class="pago-btn" data-metodo="Tarjeta">Tarjeta (Visa/Mastercard)</button>
    <button class="pago-btn" data-metodo="PayPal">PayPal</button>
    <button id="cerrar-modal" class="pago-btn cancel">Cancelar</button>
  </div>
</div> 
</body>
</html>
