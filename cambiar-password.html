<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cambiar contraseña | RecargasPaCuba</title>
  <link rel="stylesheet" href="styles/base.css?v=r1">
  <link rel="stylesheet" href="styles/app.css?v=r1">
  <script src="js/ui.js?v=r1"></script>
  <script src="js/validators.js?v=r1"></script>

  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    .wrap{
      width:100%;
      max-width:420px;
      text-align:center;
      padding:18px;
    }

    .title{
      font-size:30px;
      font-weight:800;
      margin-bottom:10px;
    }

    .sub{
      color:#e7f7fb;
      margin-bottom:20px;
      font-size:14px;
    }

    .input-pill{
      width:100%;
      border-radius:999px;
      padding:14px 18px;
      border:none;
      margin-top:14px;
      font-size:15px;
      outline:none;
      box-shadow:0 10px 26px rgba(0,0,0,0.25);
      color:#0b1924;
    }

    .password-wrap {
      position: relative;
      width: 100%;
    }

    .password-wrap .input-pill {
      padding-right: 64px;
    }

    .toggle-pass {
      position: absolute;
      right: 16px;
      top: 50%;
      transform: translateY(-50%);
      cursor: pointer;
      font-size: 13px;
      font-weight: 800;
      color: #0b1924;
      user-select: none;
    }

    .msg{
      margin-top:14px;
      font-size:13px;
    }
  </style>
</head>

<body class="page-auth">

  <div class="wrap">

    <div class="title">Cambia tu contraseña</div>
    <div class="sub">
      Por seguridad debes crear una nueva contraseña antes de continuar.
    </div>

    <div class="password-wrap">
      <input id="current-pass" class="input-pill" type="password" placeholder="Contraseña actual" autocomplete="current-password">
      <span id="toggle-pass-0" class="toggle-pass">Mostrar</span>
    </div>

    <div class="password-wrap">
      <input id="new-pass" class="input-pill" type="password" placeholder="Nueva contraseña" autocomplete="new-password">
      <span id="toggle-pass-1" class="toggle-pass">Mostrar</span>
    </div>

    <div class="password-wrap">
      <input id="new-pass2" class="input-pill" type="password" placeholder="Repetir contraseña" autocomplete="new-password">
      <span id="toggle-pass-2" class="toggle-pass">Mostrar</span>
    </div>

    <button id="btn-save" class="btn btn-accent btn-lg btn-full">Guardar nueva contraseña</button>
    <div id="msg" class="msg" style="display:none;"></div>

  </div>

  <script type="module">
    import { auth, onAuthStateChanged } from "./js/firebase.js?v=r1";
    import {
      EmailAuthProvider,
      reauthenticateWithCredential,
      updatePassword
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";

    function redirectToLoginPreservingParams() {
      const currentParams = new URLSearchParams(window.location.search || "");
      const targetUrl = new URL("index.html", window.location.href);

      let vParam = currentParams.get("v");
      if (!vParam) {
        try { vParam = sessionStorage.getItem("rpc_v"); } catch (_) {}
      }
      if (vParam) targetUrl.searchParams.set("v", vParam);

      const nextParam = currentParams.get("next");
      if (nextParam) targetUrl.searchParams.set("next", nextParam);

      window.location.replace(targetUrl.toString());
    }

    function getFirebaseUserOnce(timeoutMs = 8000) {
      return new Promise((resolve) => {
        let done = false;
        const timer = setTimeout(() => {
          if (done) return;
          done = true;
          resolve(null);
        }, timeoutMs);

        const unsub = onAuthStateChanged(auth, (user) => {
          if (done) return;
          done = true;
          clearTimeout(timer);
          try { unsub(); } catch (_) {}
          resolve(user || null);
        });
      });
    }

    function togglePassword(inputId, toggleId) {
      const input = document.getElementById(inputId);
      const toggle = document.getElementById(toggleId);
      if (!input || !toggle) return;

      toggle.addEventListener("click", () => {
        if (input.type === "password") {
          input.type = "text";
          toggle.textContent = "Ocultar";
        } else {
          input.type = "password";
          toggle.textContent = "Mostrar";
        }
      });
    }

    function mapFirebaseError(e) {
      const code = e?.code || "";
      if (code === "auth/wrong-password" || code === "auth/invalid-credential") return "La contraseña actual es incorrecta.";
      if (code === "auth/too-many-requests") return "Demasiados intentos. Intenta más tarde.";
      if (code === "auth/requires-recent-login") return "Por seguridad, vuelve a iniciar sesión e inténtalo de nuevo.";
      if (code === "auth/network-request-failed") return "Error de red. Revisa tu conexión.";
      if (code === "auth/user-disabled") return "Tu cuenta está deshabilitada.";
      return "No se pudo actualizar la contraseña. Intenta de nuevo.";
    }

    // Legacy: validación de flujo forzarCambio basado en localStorage
    const data = localStorage.getItem("usuarioRegistrado");
    if (!data) {
      redirectToLoginPreservingParams();
    } else {
      const usuario = JSON.parse(data);

      if (!usuario.forzarCambio) {
        window.location.href = "recargar.html";
      }

      // Toggles (UI consistente)
      togglePassword("current-pass", "toggle-pass-0");
      togglePassword("new-pass", "toggle-pass-1");
      togglePassword("new-pass2", "toggle-pass-2");

      const btn = document.getElementById("btn-save");
      btn.addEventListener("click", async () => {
        const currentPass = document.getElementById("current-pass").value.trim();
        const pass1 = document.getElementById("new-pass").value.trim();
        const pass2 = document.getElementById("new-pass2").value.trim();
        const msg = document.getElementById("msg");

        if (msg) msg.style.display = "none";

        if (!currentPass || !pass1 || !pass2) {
          showToastError("Completa todos los campos.");
          return;
        }

        // Misma regla de seguridad que en registro
        const strongPass = (window.Validators && typeof window.Validators.isStrongPassword === "function")
          ? window.Validators.isStrongPassword
          : (p) => /^(?=.*[A-Z])(?=.*\d).{8,}$/.test(p);

        if (!strongPass(pass1)) {
          showToastError("La contraseña debe tener mínimo 8 caracteres, una mayúscula y un número.");
          return;
        }

        if (pass1 !== pass2) {
          showToastError("Las contraseñas no coinciden.");
          return;
        }

        btn.disabled = true;
        btn.style.opacity = "0.85";

        try {
          const fbUser = await getFirebaseUserOnce(8000);
      if (!fbUser) {
       showToastError("Sesión expirada. Vuelve a iniciar sesión.");
        redirectToLoginPreservingParams();
        return;
      }

         const hasPasswordProvider =
         Array.isArray(fbUser.providerData) &&
         fbUser.providerData.some((p) => p && p.providerId === "password");

        if (!hasPasswordProvider) {
       showToastError("Esta cuenta no usa contraseña. Inicia sesión con email y contraseña para cambiarla.");
       redirectToLoginPreservingParams();
        return;
      }

         const email = fbUser.email;
     if (!email) {
      showToastError("No se pudo obtener tu email de sesión. Vuelve a iniciar sesión.");
      redirectToLoginPreservingParams();
          return;
      }
          // Reauth + updatePassword (Firebase real)
          const cred = EmailAuthProvider.credential(email, currentPass);
          await reauthenticateWithCredential(fbUser, cred);
          await updatePassword(fbUser, pass1);

          // Solo tras éxito real en Firebase: actualizar flags locales
          usuario.forzarCambio = false;
          const usuarioSan = { ...usuario };
          delete usuarioSan.pass;
          delete usuarioSan.password;
          delete usuarioSan.contrasena;
          localStorage.setItem("usuarioRegistrado", JSON.stringify(usuarioSan));

          showToastSuccess("Contraseña actualizada correctamente.");

          setTimeout(() => {
            window.location.href = "recargar.html";
          }, 1000);
        } catch (e) {
          showToastError(mapFirebaseError(e));
        } finally {
          btn.disabled = false;
          btn.style.opacity = "1";
        }
      });
    }
  </script>

  <script type="module" src="js/app.js?v=r1"></script>

  <div class="legal-links" style="text-align:center;margin-top:12px;">
    <small>
      <a href="terminos.html">Términos</a> ·
      <a href="privacidad.html">Privacidad</a> ·
      <a href="reembolsos.html">Reembolsos</a> ·
      <a href="mailto:recargaspacubaapp@gmail.com">Soporte</a>
    </small>
  </div>

</body>
</html>
