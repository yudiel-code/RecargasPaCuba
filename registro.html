<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Crear cuenta | RecargasPaCuba</title>
  <link rel="stylesheet" href="styles/base.css">
  <link rel="stylesheet" href="styles/app.css">
  <script src="js/ui.js"></script>
  <script src="js/validators.js"></script>

  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    .wrap{
      width:100%;
      max-width:420px;
      text-align:center;
      padding:18px;
    }

    .title{
      font-size:30px;
      font-weight:800;
      margin-bottom:10px;
    }

    .sub{
      color:#e7f7fb;
      margin-bottom:20px;
      font-size:14px;
    }

    .input-pill{
      width:100%;
      border-radius:999px;
      padding:14px 18px;
      border:none;
      margin-top:14px;
      font-size:15px;
      outline:none;
      box-shadow:0 10px 26px rgba(0,0,0,0.25);
      color:#0b1924;
    }

    .input-label {
      display:block;
      text-align:left;
      margin-top:12px;
      font-weight:700;
      color:#e7f7fb;
    }

    .password-wrap {
      position: relative;
      width: 100%;
    }

    .password-wrap .input-pill {
      padding-right: 46px;
    }

    .toggle-pass {
      position: absolute;
      right: 16px;
      top: 50%;
      transform: translateY(-50%);
      cursor: pointer;
      font-size: 18px;
      color: #0b1924;
      user-select: none;
      background: transparent;
      border: none;
      padding: 6px;
    }

    .toggle-pass:focus-visible {
      outline: 2px solid #0b1924;
      outline-offset: 2px;
    }

    .msg{
      margin-top:14px;
      font-size:13px;
    }

    .register-button {
      margin-top:16px;
    }

    .register-login-back {
      margin-top:14px;
      font-size:14px;
      text-align:center;
      color:#e7f7fb;
    }

    .register-login-back a {
      color:#ffffff;
      font-weight:700;
      text-decoration:underline;
    }
  </style>
</head>

<body class="page-auth">

  <div class="wrap">

    <div class="title">Crear cuenta</div>
    <div id="password-guidance" class="sub">
      Completa tus datos para registrarte (m&iacute;nimo 8 caracteres, 1 may&uacute;scula y 1 n&uacute;mero)
    </div>

    <label class="input-label" for="reg-nombre">Nombre completo</label>
    <input id="reg-nombre" class="input-pill" type="text" placeholder="Nombre completo" autocomplete="name">
    <label class="input-label" for="reg-email">Email</label>
    <input id="reg-email" class="input-pill" type="email" placeholder="Email" autocomplete="email">

    <label class="input-label" for="new-pass">Contrase&ntilde;a</label>
    <div class="password-wrap">
      <input id="new-pass" class="input-pill" type="password" placeholder="Contrase&ntilde;a" autocomplete="new-password" aria-describedby="password-guidance msg">
      <button type="button" id="toggle-pass-1" class="toggle-pass" aria-label="Mostrar contrase&ntilde;a">Mostrar</button>
    </div>

    <label class="input-label" for="new-pass2">Repetir contrase&ntilde;a</label>
    <div class="password-wrap">
      <input id="new-pass2" class="input-pill" type="password" placeholder="Repetir contrase&ntilde;a" autocomplete="new-password" aria-describedby="password-guidance msg">
      <button type="button" id="toggle-pass-2" class="toggle-pass" aria-label="Mostrar contrase&ntilde;a">Mostrar</button>
    </div>

    <button id="btn-register" class="btn btn-accent btn-lg btn-full register-button">Registrarme</button>

    <div id="msg" class="msg" style="display:none;"></div>

    <p class="register-login-back">
      <a href="index.html">&larr; Volver al login</a>
    </p>

  </div>

  <div class="legal-links" style="text-align:center;margin-top:12px;">
    <small>
      <a href="terminos.html">Terminos</a> ·
      <a href="privacidad.html">Privacidad</a> ·
      <a href="reembolsos.html">Reembolsos</a> ·
      <a href="mailto:recargaspacubaapp@gmail.com">Soporte</a>
    </small>
  </div>

  <script type="module" src="js/firebase.js"></script>

  <script>
    // Cargamos el usuario guardado
    const data = localStorage.getItem("usuarioRegistrado");
    let usuario = {};
    try {
      usuario = data ? JSON.parse(data) : {};
    } catch (e) {
      console.warn("No se pudo parsear usuarioRegistrado, usando objeto vacio.");
      usuario = {};
    }

    // Solo redirigimos si ya hay usuario y NO necesita cambio/registro
    window.addEventListener("load", () => {
      const tieneUsuarioPrevio = usuario && (usuario.email || usuario.usuario);
      const authInicial = window.firebaseAuth || null;
      const userInicial = authInicial && authInicial.currentUser;
      if (userInicial && tieneUsuarioPrevio && usuario.forzarCambio === false) {
        const params = new URLSearchParams(window.location.search || "");
        let vParam = params.get("v");
        if (!vParam) {
          try { vParam = sessionStorage.getItem("rpc_v"); } catch (_) {}
        }
        const targetUrl = new URL("recargar.html", window.location.href);
        targetUrl.searchParams.set("next", "recargar.html");
        if (vParam) targetUrl.searchParams.set("v", vParam);
        window.location.href = targetUrl.toString();
      }
    });    const btnRegister = document.getElementById("btn-register");
    btnRegister.addEventListener("click", async () => {
      const nombre = (document.getElementById("reg-nombre").value || "").trim();
      const email = (document.getElementById("reg-email").value || "").trim().toLowerCase();
      const pass1 = document.getElementById("new-pass").value.trim();
      const pass2 = document.getElementById("new-pass2").value.trim();
      const msg = document.getElementById("msg");
      if (msg) msg.style.display = "none";

      if (!nombre || !email || !pass1 || !pass2) {
        showToastError("Completa todos los campos.");
        return;
      }

      const strongPass = (window.Validators && typeof window.Validators.isStrongPassword === "function")
        ? window.Validators.isStrongPassword
        : (p) => /^(?=.*[A-Z])(?=.*\d).{8,}$/.test(p);

      if (!strongPass(pass1)) {
        showToastError("La contrasena debe tener minimo 8 caracteres, una mayuscula y un numero.");
        return;
      }

      if (pass1 !== pass2) {
        showToastError("Las contrasenas no coinciden.");
        return;
      }

      const createUser = window.firebaseCreateUser;
      const updateProfile = window.firebaseUpdateProfile;
      const auth = window.firebaseAuth;

      if (!createUser || !updateProfile || !auth) {
        showToastError("Servicio de registro no disponible. Intentalo de nuevo en unos minutos.");
        return;
      }

      try {
        const cred = await createUser(auth, email, pass1);
        await updateProfile(cred.user, { displayName: nombre });

        const usuarioMin = {
          nombre: nombre,
          usuario: nombre,
          email: email,
          activo: true
        };

        localStorage.setItem("usuarioRegistrado", JSON.stringify(usuarioMin));
        localStorage.setItem("usuario", email);

        showToastSuccess("Registro completado. Redirigiendo...");
        try {
          const signOut = window.firebaseSignOut || (window.firebaseAuth && window.firebaseAuth.signOut);
          if (typeof signOut === "function") {
            await Promise.resolve(signOut()).catch(() => {});
          }
        } catch (e) {
          console.warn("No se pudo cerrar sesión tras registro:", e);
        }
        localStorage.removeItem("usuario");
        localStorage.removeItem("usuarioRegistrado");
        const currentParams = new URLSearchParams(window.location.search || "");
        const targetUrl = new URL("index.html", window.location.href);
        let vParam = currentParams.get("v");
        if (!vParam) {
          try { vParam = sessionStorage.getItem("rpc_v"); } catch (_) {}
        }
        if (vParam) {
          targetUrl.searchParams.set("v", vParam);
        }
        const nextParam = currentParams.get("next");
        if (nextParam) {
          targetUrl.searchParams.set("next", nextParam);
        }
        window.location.href = targetUrl.toString();
      } catch (error) {
        console.error("Error en registro:", error);
        let mensaje = "No se pudo completar el registro.";
        if (error.code === "auth/email-already-in-use") {
          mensaje = "Este correo ya esta registrado.";
        } else if (error.code === "auth/invalid-email") {
          mensaje = "Correo no valido.";
        } else if (error.code === "auth/weak-password") {
          mensaje = "La contrasena es muy debil.";
        }
        showToastError(mensaje);
      }
    });

    // Ojito 1
    document.getElementById("toggle-pass-1").addEventListener("click", () => {
      const input = document.getElementById("new-pass");
      const icon = document.getElementById("toggle-pass-1");
      if (input.type === "password") {
        input.type = "text";
        icon.textContent = "Ocultar";
        icon.setAttribute("aria-label", "Ocultar contrase\u00f1a");
      } else {
        input.type = "password";
        icon.textContent = "Mostrar";
        icon.setAttribute("aria-label", "Mostrar contrase\u00f1a");
      }
    });

    document.getElementById("toggle-pass-2").addEventListener("click", () => {
      const input = document.getElementById("new-pass2");
      const icon = document.getElementById("toggle-pass-2");
      if (input.type === "password") {
        input.type = "text";
        icon.textContent = "Ocultar";
        icon.setAttribute("aria-label", "Ocultar contrase\u00f1a");
      } else {
        input.type = "password";
        icon.textContent = "Mostrar";
        icon.setAttribute("aria-label", "Mostrar contrase\u00f1a");
      }
    });
  </script>

  <script type="module" src="js/app.js"></script>
</body>
</html>




