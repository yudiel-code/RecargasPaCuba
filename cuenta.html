<!DOCTYPE html> 
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Cuenta | RecargasPaCuba</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <meta name="color-scheme" content="light">
  <meta name="theme-color" content="#28c6db">
  <link rel="stylesheet" href="styles/base.css">
  <link rel="stylesheet" href="styles/app.css">
  <script src="js/ui.js"></script>

</head>

<body class="page-cuenta">
  <div class="app">
    <header class="app-header">
      <div>
        <div class="header-title">Tu cuenta</div>
        <div class="estado-online">
          <span class="dot"></span>
          <span>Servicio activo</span>
        </div>
      </div>
    </header>

    <div class="app-scroll">
      <section class="card card--gradient">
        <div class="card-header">
          <div>
            <div class="card-title">Saldo RecargasPaCuba</div>
            <div class="card-sub">Controla tu saldo disponible y tus últimos movimientos</div>
          </div>
          <div class="card-tag">
            <span class="dot"></span>
            <span>Seguro y en España</span>
          </div>
        </div>

        <div class="card-main">
          <div>
            <div class="mini-label">Saldo disponible</div>
            <div id="saldo" class="saldo-valor">0,00 €</div>
            <div id="ultimoMovimiento" class="ultima-linea">Último movimiento: Aún no tienes movimientos</div>
          </div>
          <div>
            <button id="addSaldoBtn" class="btn-small primary">
              <svg viewBox="0 0 24 24" fill="none">
                <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
              Añadir saldo
            </button>
          </div>
        </div>

        <div class="card-footer">
          <div class="pill-info">Tarifa sin permanencia</div>
          <div class="pill-info">Registro en España</div>
          <div class="pill-info">Historial accesible al instante</div>
        </div>
      </section>

      <section class="card card--gradient">
        <div class="card-header">
          <div>
            <div class="card-title">Perfil de usuario</div>
            <div class="card-sub">Gestiona tus datos principales y tu avatar</div>
          </div>
        </div>

        <div class="usuario-box">
          <div class="avatar" id="avatarBox">
            <div class="avatar-letra" id="avatarLetra">Y</div>
            <img id="avatarImg" alt="Avatar usuario">
            <small>Editar</small>
          </div>
          <input id="inputAvatar" type="file" accept="image/*" style="display:none;" />
          <div class="usuario-datos">
            <div class="nombre" id="nombreUsuario">Usuario</div>
            <div class="correo" id="correoUsuario">correo@ejemplo.com</div>
            <div class="tag">Cuenta creada y gestionada desde España</div>
          </div>
          <button class="btn-icon" id="editarCuentaBtn" title="Editar datos de cuenta">
            <svg viewBox="0 0 24 24" fill="none">
              <path d="M4 20h4l10-10-4-4L4 16v4z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
            </svg>
          </button>
        </div>

        <div class="subgrid">
          <div class="sub-card">
            <span class="label">Estado de la cuenta</span>
            <span class="valor" id="estadoCuenta">Activa</span>
            <div class="cta">
              Verifica que tus datos estén siempre <strong>actualizados</strong>.
            </div>
          </div>
          <div class="sub-card">
            <span class="label">Contacto preferido</span>
            <span class="valor">Correo electrónico</span>
            <div class="cta">
              Escríbenos siempre desde el email que usas en <strong>RecargasPaCuba</strong>.
            </div>
          </div>
        </div>

        <button id="soporteBtn" class="btn-small secondary" style="margin-top:12px;">
          <svg viewBox="0 0 24 24" fill="none">
            <path d="M12 3a9 9 0 0 0-9 9v3a3 3 0 0 0 3 3h1v-7H6a6 6 0 0 1 12 0h-1v7h1a3 3 0 0 0 3-3v-3a9 9 0 0 0-9-9z" stroke="currentColor" stroke-width="2"/>
          </svg>
          Contactar soporte
        </button>

        <button id="logoutBtn" class="logout-btn">
          <span class="icon">⏏</span>
          <span>Cerrar sesión de forma segura</span>
        </button>

        <ul class="seguridad-lista">
          <li>
            <span class="bullet"></span>
            <span>No compartas tu contraseña con nadie, ni siquiera con soporte.</span>
          </li>
          <li>
            <span class="bullet"></span>
            <span>Si detectas un acceso raro, cambia tu contraseña desde la app.</span>
          </li>
        </ul>
      </section>

      <section class="card card--gradient">
        <div class="card-header">
          <div>
            <div class="card-title">Programa de monedas</div>
            <div class="card-sub">Gana recompensas con tus recargas recurrentes</div>
          </div>
          <svg class="monedas-icon" viewBox="0 0 64 64">
            <circle cx="22" cy="22" r="12" stroke="currentColor" stroke-width="2" fill="none"/>
            <circle cx="42" cy="32" r="12" stroke="currentColor" stroke-width="2" fill="none"/>
            <circle cx="26" cy="42" r="12" stroke="currentColor" stroke-width="2" fill="none"/>
          </svg>
        </div>

        <div class="card-main" style="align-items:flex-start;">
          <div class="monedas-resumen">
            <div class="monedas-valores">
              <div class="principal"><span id="monedasActuales">0</span> monedas</div>
              <div class="secundario">Recarga y acumula hasta llegar a tu recompensa</div>
            </div>
          </div>
        </div>

        <div class="barra-progreso-wrap">
          <div class="barra-progreso-label">
            <span>Progreso hacia el canje</span>
            <span id="monedasProgresoTexto">0 / 699</span>
          </div>
          <div class="barra-progreso">
            <div id="barraProgresoInner" class="barra-progreso-inner"></div>
          </div>
        </div>

        <table class="tabla-monedas">
          <thead>
            <tr>
              <th>Recarga</th>
              <th>Importe</th>
              <th>Monedas</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Cubacel</td>
              <td>10 €</td>
              <td>13</td>
            </tr>
            <tr>
              <td>Cubacel</td>
              <td>20 €</td>
              <td>27</td>
            </tr>
            <tr>
              <td>Cubacel</td>
              <td>30 €</td>
              <td>41</td>
            </tr>
            <tr>
              <td>Cubacel</td>
              <td>50 €</td>
              <td><span class="destacado">69</span></td>
            </tr>
            <tr>
              <td>Nauta</td>
              <td>Cualquier importe</td>
              <td>5 (fijo)</td>
            </tr>
          </tbody>
        </table>

        <ul class="card-lista">
          <li>
            <span class="bullet"></span>
            <span>Las monedas se suman automáticamente cada vez que completas una recarga.</span>
          </li>
          <li>
            <span class="bullet"></span>
            <span>Al llegar a <strong>699 monedas</strong>, podrás solicitar tu <strong>canje de 20 €</strong>.</span>
          </li>
          <li>
            <span class="bullet"></span>
            <span>Las monedas no son dinero real, son puntos promocionales internos.</span>
          </li>
        </ul>

        <div class="canje-wrap">
          <div class="canje-info">
            <strong>Canje disponible a partir de 699 monedas.</strong><br>
            Una vez canjeado, el saldo promocional se sumará a tu balance para futuras recargas.
          </div>
          <button id="btnCanje" class="btn-canje">
            Canjear 699 monedas por 20 €
          </button>
        </div>
      </section>

      <section class="card card--gradient">
        <div class="card-header">
          <div>
            <div class="card-title">Centro legal</div>
            <div class="card-sub">Información legal y documentación de tu cuenta y la app</div>
          </div>
        </div>

        <ul class="link-list">
          <li>
            <div class="link-item">
              <div class="link-icon">📋</div>
              <div>
                <div class="link-text-main">Términos y condiciones</div>
                <div class="link-text-sub">Información legal y condiciones de uso</div>
              </div>
            </div>
            <div class="link-chevron">›</div>
          </li>

          <li>
            <div class="link-item">
              <div class="link-icon">🔐</div>
              <div>
                <div class="link-text-main">Política de privacidad</div>
                <div class="link-text-sub">Datos tratados y cómo los protegemos</div>
              </div>
            </div>
            <div class="link-chevron">›</div>
          </li>

          <li>
            <div class="link-item">
              <div class="link-icon">💳</div>
              <div>
                <div class="link-text-main">Política de reembolsos</div>
                <div class="link-text-sub">Información clave sobre devoluciones</div>
              </div>
            </div>
            <div class="link-chevron">›</div>
          </li>
        </ul>
      </section>
    </div>
  </div>

  <nav class="app-nav">
    <div class="nav-inner">
      <a href="recargar.html" class="nav-btn">
        <span>⚡</span>
        <div>Recargar</div>
      </a>
      <a href="historial.html" class="nav-btn">
        <span>🕑</span>
        <div>Historial</div>
      </a>
      <a href="cuenta.html" class="nav-btn active">
        <span>👤</span>
        <div>Cuenta</div>
      </a>
    </div>
  </nav>

  <div id="modalMetodo" class="modal-bg">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">Seleccionar método de pago</div>
        <button class="modal-close" data-close="metodo">×</button>
      </div>
      <div class="modal-body">
        <p>Elige cómo quieres añadir saldo a tu monedero RecargasPaCuba.</p>
        <div class="selector-banco">
          <div class="banco-pill metodo-opcion" data-metodo="bizum">
            <div>
              <span class="nombre">Bizum</span><br>
              <span class="tag">En segundos</span>
            </div>
            <div>📲</div>
          </div>
          <div class="banco-pill metodo-opcion" data-metodo="transferencia">
            <div>
              <span class="nombre">Transferencia</span><br>
              <span class="tag">24-48 horas</span>
            </div>
            <div>🏦</div>
          </div>
          <div class="banco-pill metodo-opcion" data-metodo="paypal">
            <div>
              <span class="nombre">PayPal</span><br>
              <span class="tag">Pago online</span>
            </div>
            <div>🅿️</div>
          </div>
          <div class="banco-pill metodo-opcion" data-metodo="tarjeta">
            <div>
              <span class="nombre">Visa &amp; Mastercard</span><br>
              <span class="tag">Tarjeta bancaria</span>
            </div>
            <div>💳</div>
          </div>
        </div>
        <p style="font-size:11px;opacity:0.85;">
          Por ahora este panel es informativo. Más adelante, al activarlo, verás los datos
          reales (Bizum, transferencia, PayPal o tarjeta) y las confirmaciones de pago dentro de la app.
        </p>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" data-close="metodo">Cerrar</button>
      </div>
    </div>
  </div>

  <div id="modalSaldo" class="modal-bg">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">Añadir saldo manual</div>
        <button class="modal-close" data-close="saldo">×</button>
      </div>
      <div class="modal-body">
        <p>Introduce el importe que quieres añadir a tu saldo una vez confirmado el pago.</p>
        <div id="metodoResumen" class="metodo-resumen" style="display:none;">
          <span>Método seleccionado: <strong id="metodoSeleccionadoTexto"></strong></span>
          <button id="cambiarMetodoBtn" type="button" class="metodo-cambiar">Cambiar</button>
        </div>
        <div class="campo-saldo">
          <input id="inputSaldo" type="number" min="0" step="1" placeholder="Ej: 20">
          <span>€</span>
        </div>
        <p style="font-size:11px;opacity:0.85;margin-top:8px;">
          Este panel está pensado para uso interno. Úsalo solo cuando hayas confirmado el pago
          (Bizum, transferencia, PayPal o tarjeta).
        </p>
      </div>
      <div class="modal-footer">
        <span class="alerta">
          Recuerda registrar los movimientos de saldo también en tu control interno.
        </span>
        <button class="btn-secondary" data-close="saldo">Cancelar</button>
        <button id="confirmarSaldoBtn" class="btn-primary">Guardar saldo</button>
      </div>
    </div>
  </div>

  <div id="modalCuenta" class="modal-bg">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">Datos de tu cuenta</div>
        <button class="modal-close" data-close="cuenta">×</button>
      </div>
      <div class="modal-body">
        <div class="cuenta-campos">
          <div class="campo">
            <div class="campo-label">Nombre completo</div>
            <input id="cuentaNombre" type="text" placeholder="Tu nombre">
          </div>
          <div class="campo">
            <div class="campo-label">Correo principal</div>
            <input id="cuentaCorreo" type="email" placeholder="correo@ejemplo.com">
          </div>
          <div class="campo">
            <div class="campo-label">Contraseña (solo para cambiarla)</div>
            <div class="password-wrap" style="position:relative;">
              <input id="cuentaPass" type="password" placeholder="Deja vacío si no quieres cambiarla">
              <span id="togglePass" class="ojo-toggle">👁</span>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <span class="alerta">
          Estos cambios solo afectan a tu acceso y comunicación con RecargasPaCuba.
        </span>
        <button class="btn-secondary" data-close="cuenta">Cancelar</button>
        <button id="guardarCuentaBtn" class="btn-primary">Guardar cambios</button>
      </div>
    </div>
  </div>

  <!-- DATA LOCAL CENTRALIZADA -->
  <script src="js/userData.js"></script>

  <!-- SCRIPT PRINCIPAL -->
  <script>
    const usuarioSesion = localStorage.getItem("usuario");

    let datosUsuario;
    try {
      datosUsuario = JSON.parse(localStorage.getItem("usuarioRegistrado") || "{}");
    } catch (e) {
      console.error("Error leyendo usuarioRegistrado, usando objeto vacío:", e);
      datosUsuario = {};
    }

    // B1.2: asegurarnos de que no quede contraseña guardada en localStorage
    if (datosUsuario && datosUsuario.pass) {
      delete datosUsuario.pass;
      localStorage.setItem("usuarioRegistrado", JSON.stringify(datosUsuario));
    }

    if (!usuarioSesion) {
      window.location.href = "index.html";
    }

    const nombreMostrar = datosUsuario.nombre || "Usuario";
    const nombreUsuarioEl = document.getElementById("nombreUsuario");
    if (nombreUsuarioEl) nombreUsuarioEl.textContent = nombreMostrar;

    const correoMostrar = datosUsuario.email || "correo@ejemplo.com";
    const correoUsuarioEl = document.getElementById("correoUsuario");
    if (correoUsuarioEl) correoUsuarioEl.textContent = correoMostrar;

    // ===== Capa de acceso a saldo / historial vía UserData (preparada para backend) =====
    function getSaldo() {
      if (window.UserData && typeof window.UserData.getSaldo === "function") {
        return window.UserData.getSaldo();
      }
      console.warn("UserData.getSaldo no disponible; devolviendo 0.");
      return 0;
    }

    function setSaldo(nuevoSaldo) {
      if (window.UserData && typeof window.UserData.setSaldo === "function") {
        window.UserData.setSaldo(nuevoSaldo);
        return;
      }
      console.warn("UserData.setSaldo no disponible; saldo no persistido.");
    }

    function getHistorialSeguro() {
      if (window.UserData && typeof window.UserData.getHistorial === "function") {
        const lista = window.UserData.getHistorial();
        return Array.isArray(lista) ? lista : [];
      }
      console.warn("UserData.getHistorial no disponible; usando lista vacía.");
      return [];
    }

    function guardarMovimientoSaldo(importe, metodo) {
      if (window.UserData && typeof window.UserData.addMovimientoSaldo === "function") {
        window.UserData.addMovimientoSaldo(importe, metodo || "manual");
        if (window.UserData && typeof window.UserData.recalcularMonedas === "function") {
          window.UserData.recalcularMonedas();
        }
        return;
      }
      console.warn("UserData.addMovimientoSaldo no disponible; movimiento no guardado.");
    }

    function cargarSaldo() {
      const saldo = getSaldo();
      const saldoEl = document.getElementById("saldo");
      if (saldoEl) {
        saldoEl.textContent = saldo.toFixed(2) + " €";
      }
    }

    function cargarUltimoMovimiento() {
      const cont = document.getElementById("ultimoMovimiento");
      if (!cont) return;

      const historial = getHistorialSeguro();

      if (!historial.length) {
        cont.textContent = "Último movimiento: sin actividad";
        return;
      }

      const ultimo = historial[0];

      if (ultimo.tipo === "recarga") {
        cont.textContent =
          "Último movimiento: Recarga de " +
          Number(ultimo.importe || 0).toFixed(2) + " € a " + (ultimo.numero || "");
      } else if (ultimo.tipo === "saldo") {
        cont.textContent =
          "Último movimiento: Saldo añadido de " +
          Number(ultimo.importe || 0).toFixed(2) + " €";
      } else {
        cont.textContent = "Último movimiento: " + (ultimo.descripcion || "sin descripción");
      }
    }

    function getMetodoPagoActual() {
      return localStorage.getItem("rpc_metodo_pago") || "";
    }

    function setMetodoPagoActual(metodo) {
      localStorage.setItem("rpc_metodo_pago", metodo);
      marcarMetodoActivo();
      actualizarTextoMetodo();
    }

    const modalMetodo = document.getElementById("modalMetodo");
    const modalSaldo  = document.getElementById("modalSaldo");
    const modalCuenta = document.getElementById("modalCuenta");
    const inputSaldo  = document.getElementById("inputSaldo");

    function obtenerNombreMetodo(metodo) {
      switch (metodo) {
        case "bizum": return "Bizum";
        case "transferencia": return "Transferencia";
        case "paypal": return "PayPal";
        case "tarjeta": return "Visa & Mastercard";
        default: return "";
      }
    }

    function actualizarTextoMetodo() {
      const metodo = getMetodoPagoActual();
      const contenedor = document.getElementById("metodoResumen");
      const texto = document.getElementById("metodoSeleccionadoTexto");
      if (!contenedor || !texto) return;

      const nombre = obtenerNombreMetodo(metodo);
      if (nombre) {
        texto.textContent = nombre;
        contenedor.style.display = "flex";
      } else {
        contenedor.style.display = "none";
      }
    }

    function marcarMetodoActivo() {
      const actual = getMetodoPagoActual();
      document.querySelectorAll(".metodo-opcion").forEach(function(op) {
        const metodo = op.getAttribute("data-metodo");
        if (metodo === actual) {
          op.classList.add("active");
        } else {
          op.classList.remove("active");
        }
      });
    }

    function abrirModalMetodo() {
      if (modalMetodo) {
        marcarMetodoActivo();
        modalMetodo.style.display = "flex";
      }
    }

    function cerrarModalMetodo() {
      if (modalMetodo) modalMetodo.style.display = "none";
    }

    function abrirModalSaldo() {
      if (modalSaldo) {
        actualizarTextoMetodo();
        modalSaldo.style.display = "flex";
      }
    }

    function cerrarModalSaldo() {
      if (modalSaldo) modalSaldo.style.display = "none";
      if (inputSaldo) inputSaldo.value = "";
    }

    function abrirModalCuenta() {
      if (!modalCuenta) return;
      modalCuenta.style.display = "flex";
      const nombreInput = document.getElementById("cuentaNombre");
      const correoInput = document.getElementById("cuentaCorreo");
      const passInput   = document.getElementById("cuentaPass");

      if (nombreInput) nombreInput.value = datosUsuario.nombre || "";
      if (correoInput) correoInput.value = datosUsuario.email || "";
      if (passInput)   passInput.value   = "";
    }

    function cerrarModalCuenta() {
      if (modalCuenta) modalCuenta.style.display = "none";
    }

    document.querySelectorAll(".modal-close").forEach(function(btn) {
      btn.addEventListener("click", function() {
        const tipo = btn.getAttribute("data-close");
        if (tipo === "metodo") cerrarModalMetodo();
        if (tipo === "saldo") cerrarModalSaldo();
        if (tipo === "cuenta") cerrarModalCuenta();
      });
    });

    document.querySelectorAll(".modal-bg").forEach(function(bg) {
      bg.addEventListener("click", function(e) {
        if (e.target !== bg) return;
        if (bg.id === "modalMetodo") {
          cerrarModalMetodo();
        } else if (bg.id === "modalSaldo") {
          cerrarModalSaldo();
        } else if (bg.id === "modalCuenta") {
          cerrarModalCuenta();
        } else {
          bg.style.display = "none";
        }
      });
    });

    const editarCuentaBtn = document.getElementById("editarCuentaBtn");
    if (editarCuentaBtn) {
      editarCuentaBtn.addEventListener("click", abrirModalCuenta);
    }

    const guardarCuentaBtn = document.getElementById("guardarCuentaBtn");
    if (guardarCuentaBtn) {
      guardarCuentaBtn.addEventListener("click", function() {
        const nombreInput = document.getElementById("cuentaNombre");
        const correoInput = document.getElementById("cuentaCorreo");
        const passInput   = document.getElementById("cuentaPass");

        const nuevoNombre = (nombreInput && nombreInput.value ? nombreInput.value : "").trim();
        const nuevoCorreo = (correoInput && correoInput.value ? correoInput.value : "").trim().toLowerCase();
        const nuevaPass   = (passInput && passInput.value ? passInput.value : "").trim();

        if (!nuevoNombre || !nuevoCorreo) {
          showToastError("Nombre y correo no pueden estar vacíos.");
          return;
        }

        datosUsuario.nombre = nuevoNombre;
        datosUsuario.email  = nuevoCorreo;

        // B1.2: NO guardamos contraseña en localStorage
        if (datosUsuario && datosUsuario.pass) {
          delete datosUsuario.pass;
        }
        if (nuevaPass) {
          // Se ignorará hasta conectar con el flujo real de cambio de contraseña (B1.4)
        }

        localStorage.setItem("usuarioRegistrado", JSON.stringify(datosUsuario));
        localStorage.setItem("usuario", nuevoCorreo);

        const nombreCab = document.getElementById("nombreUsuario");
        const correoCab = document.getElementById("correoUsuario");

        if (nombreCab) nombreCab.textContent = nuevoNombre;
        if (correoCab) correoCab.textContent = nuevoCorreo;

        showToastSuccess("Datos de cuenta actualizados (a nivel interno de la app).");
        cerrarModalCuenta();
      });
    }

    const togglePass = document.getElementById("togglePass");
    if (togglePass) {
      togglePass.addEventListener("click", function() {
        const input = document.getElementById("cuentaPass");
        const icon  = document.getElementById("togglePass");
        if (!input || !icon) return;

        if (input.type === "password") {
          input.type = "text";
          icon.textContent = "🙈";
        } else {
          input.type = "password";
          icon.textContent = "👁";
        }
      });
    }

    document.querySelectorAll(".link-list li").forEach(function(li) {
      li.style.cursor = "pointer";
    });

    document.querySelectorAll(".link-list li").forEach(function(li, idx) {
      li.addEventListener("click", function() {
        if (idx === 0) {
          window.location.href = "terminos.html";
        } else if (idx === 1) {
          window.location.href = "privacidad.html";
        } else if (idx === 2) {
          window.location.href = "reembolsos.html";
        }
      });
    });

    const soporteBtn = document.getElementById("soporteBtn");
    if (soporteBtn) {
      soporteBtn.addEventListener("click", function() {
        window.location.href =
          "mailto:recargaspacubaapp@gmail.com" +
          "?subject=Soporte%20RecargasPaCuba" +
          "&body=Hola%20equipo%20RecargasPaCuba,%0D%0A%0D%0A";
      });
    }

    const logoutBtn = document.getElementById("logoutBtn");
    if (logoutBtn) {
      logoutBtn.addEventListener("click", function() {
        localStorage.removeItem("usuario");
        if (window.firebaseSignOut) {
          window.firebaseSignOut().catch(function() {});
        }
        window.location.href = "index.html";
      });
    }

    const avatarBox   = document.getElementById("avatarBox");
    const inputAvatar = document.getElementById("inputAvatar");
    const avatarImg   = document.getElementById("avatarImg");
    const avatarLetra = document.getElementById("avatarLetra");

    function inicializarAvatar() {
      if (!avatarLetra || !avatarImg) return;
      let avatarData = "";

      if (window.UserData && typeof window.UserData.getAvatar === "function") {
        avatarData = window.UserData.getAvatar();
      } else {
        console.warn("UserData.getAvatar no disponible; usando avatar por defecto.");
      }

      const inicial = (nombreMostrar || "U").charAt(0).toUpperCase();
      avatarLetra.textContent = inicial;

      if (avatarData) {
        avatarImg.src = avatarData;
        avatarImg.style.display = "block";
        avatarLetra.style.display = "none";
      } else {
        avatarImg.style.display = "none";
        avatarLetra.style.display = "flex";
      }
    }

    if (avatarBox && inputAvatar) {
      avatarBox.addEventListener("click", function() {
        inputAvatar.click();
      });

      inputAvatar.addEventListener("change", function(event) {
        if (!event || !event.target) return;
        var files = event.target.files ? event.target.files : null;
        var file = (files && files.length > 0) ? files[0] : null;
        if (!file || !avatarImg || !avatarLetra) return;

        var reader = new FileReader();
        reader.onload = function(e) {
          var dataURL = e.target && e.target.result ? e.target.result : null;
          if (!dataURL) return;

          if (window.UserData && typeof window.UserData.setAvatar === "function") {
            window.UserData.setAvatar(dataURL);
          } else {
            console.warn("UserData.setAvatar no disponible; avatar solo en memoria.");
          }

          avatarImg.src = dataURL;
          avatarImg.style.display = "block";
          avatarLetra.style.display = "none";
        };
        reader.readAsDataURL(file);
      });
    }

    function obtenerMonedasCubacel(importe) {
      const packs = [
        { ref: 10, coins: 13 },
        { ref: 20, coins: 27 },
        { ref: 30, coins: 41 },
        { ref: 50, coins: 69 }
      ];

      let elegido = packs[0];
      packs.forEach(function(p) {
        if (Math.abs(importe - p.ref) < Math.abs(importe - elegido.ref)) {
          elegido = p;
        }
      });
      return elegido.coins;
    }

    function actualizarUIConMonedas(totalMonedas) {
      const monedasActualesEl     = document.getElementById("monedasActuales");
      const monedasProgresoTexto  = document.getElementById("monedasProgresoTexto");
      const barraProgresoInner    = document.getElementById("barraProgresoInner");

      if (monedasActualesEl)    monedasActualesEl.textContent = totalMonedas;
      const objetivo = 699;
      const progreso = Math.min(100, (totalMonedas / objetivo) * 100);

      if (monedasProgresoTexto) {
        monedasProgresoTexto.textContent = totalMonedas + " / " + objetivo;
      }
      if (barraProgresoInner) {
        barraProgresoInner.style.width = progreso + "%";
      }

      const btnCanjeLocal = document.getElementById("btnCanje");
      if (btnCanjeLocal) {
        if (totalMonedas >= objetivo) {
          btnCanjeLocal.classList.add("activo");
          btnCanjeLocal.textContent = "Canjear ahora 699 monedas por 20 €";
        } else {
          btnCanjeLocal.classList.remove("activo");
          btnCanjeLocal.textContent = "Canjear 699 monedas por 20 €";
        }
      }
    }

    function calcularMonedas() {
      let totalMonedas = 0;

      if (window.UserData && typeof window.UserData.recalcularMonedas === "function") {
        totalMonedas = window.UserData.recalcularMonedas();
      } else {
        const historial = getHistorialSeguro();
        historial.forEach(function(item) {
          if (item.tipo === "recarga") {
            const imp = Number(item.importe) || 0;
            const operador = item.operador || "";

            if (operador === "Cubacel") {
              totalMonedas += obtenerMonedasCubacel(imp);
            } else if (operador === "Nauta") {
              totalMonedas += 5;
            } else {
              if (imp > 0) {
                totalMonedas += obtenerMonedasCubacel(imp);
              }
            }
          }
        });
      }

      actualizarUIConMonedas(totalMonedas);
    }

    const confirmarSaldoBtn = document.getElementById("confirmarSaldoBtn");
    if (confirmarSaldoBtn && inputSaldo) {
      confirmarSaldoBtn.addEventListener("click", function() {
        const valor = parseFloat(inputSaldo.value);
        if (isNaN(valor)) {
          showToastError("Introduce un importe válido.");
          return;
        }

        if (valor < 10) {
          showToastError("El importe mínimo para agregar saldo es de 10 €.");
          return;
        }

        const saldoActual = getSaldo();
        const nuevoSaldo = saldoActual + valor;
        setSaldo(nuevoSaldo);

        const metodoActual = getMetodoPagoActual() || "manual";
        guardarMovimientoSaldo(valor, metodoActual);

        cargarSaldo();
        cargarUltimoMovimiento();
        calcularMonedas();
        showToastSuccess("Saldo actualizado correctamente.");
        cerrarModalSaldo();
      });
    }

    document.querySelectorAll(".metodo-opcion").forEach(function(op) {
      op.addEventListener("click", function() {
        const metodo = op.getAttribute("data-metodo");
        if (!metodo) return;
        setMetodoPagoActual(metodo);
        cerrarModalMetodo();
        abrirModalSaldo();
      });
    });

    const addSaldoBtn = document.getElementById("addSaldoBtn");
    if (addSaldoBtn) {
      addSaldoBtn.addEventListener("click", function() {
        const metodo = getMetodoPagoActual();
        if (!metodo) {
          abrirModalMetodo();
        } else {
          abrirModalSaldo();
        }
      });
    }

    const cambiarMetodoBtn = document.getElementById("cambiarMetodoBtn");
    if (cambiarMetodoBtn) {
      cambiarMetodoBtn.addEventListener("click", function() {
        cerrarModalSaldo();
        abrirModalMetodo();
      });
    }

    const btnCanje = document.getElementById("btnCanje");
    if (btnCanje) {
      btnCanje.addEventListener("click", function() {
        if (!btnCanje.classList.contains("activo")) return;
        showToastSuccess("Canje disponible: aquí podrás reclamar tus 20 € cuando esté conectado al sistema real.");
      });
    }

    cargarSaldo();
    cargarUltimoMovimiento();
    inicializarAvatar();
    calcularMonedas();
    marcarMetodoActivo();
    actualizarTextoMetodo();
  </script>

  <!-- SCRIPT FIREBASE (centralizado con js/firebase.js) -->
  <script type="module">
    import { auth, onAuthStateChanged, signOut } from "./js/firebase.js";

    // Exponemos un signOut ya vinculado a este auth para el script no-módulo
    window.firebaseSignOut = function() {
      return signOut(auth);
    };

    onAuthStateChanged(auth, (user) => {
      if (!user) {
        localStorage.removeItem("usuario");
        window.location.href = "index.html";
        return;
      }

      try {
        const raw = localStorage.getItem("usuarioRegistrado") || "{}";
        const datos = JSON.parse(raw);

        // B1.2: limpiamos cualquier rastro de pass al sincronizar
        const { pass, ...resto } = datos || {};

        const nuevo = {
          ...resto,
          nombre: (datos && datos.nombre) || user.displayName || "Usuario",
          email: (user.email || "").toLowerCase(),
          activo: true
        };

        localStorage.setItem("usuarioRegistrado", JSON.stringify(nuevo));
        localStorage.setItem("usuario", (user.email || "").toLowerCase());

        const nombreCab = document.getElementById("nombreUsuario");
        const correoCab = document.getElementById("correoUsuario");

        if (nombreCab)  nombreCab.textContent  = nuevo.nombre;
        if (correoCab)  correoCab.textContent  = nuevo.email;
      } catch (e) {
        console.error("Error sincronizando cuenta con Firebase:", e);
      }
    });
  </script>

  <script type="module" src="js/app.js"></script>
</body>
</html>










