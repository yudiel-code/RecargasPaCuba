﻿<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="color-scheme" content="light">
  <meta name="theme-color" content="#28c6db">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#28c6db">
  <title>Recargar | RecargasPaCuba</title>
  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="styles/base.css">
  <link rel="stylesheet" href="styles/app.css">
  <meta name="theme-color" content="#0b5bd3">

  <!-- ✅ EmailJS para correo de recarga -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <script src="js/ui.js"></script>

  </head>

<body class="page-recargar">

  <main class="app">
    <div class="app-content">

    <!-- PESTAÑAS -->
    <div class="tabs">
      <div class="tab active" data-tipo="cubacel">CUBACEL</div>
      <div class="tab" data-tipo="nauta">NAUTA</div>
    </div>

    <!-- TARJETAS CUBACEL -->
    <section class="cards cards-cubacel">

      <!-- OFERTA 1 -->
      <article class="card card--gradient">
        <div class="card-header">
          <span class="badge">Recarga normal</span>
          <span class="tag-operator">CUBACEL · Cuba</span>
        </div>

        <div class="card-main">
          <div class="price-block">
            <div class="price">10,42 €</div>
            <div class="price-label">Precio final</div>
          </div>
          <div class="receive-block">
            <div class="receive-label">Recibe</div>
            <div class="receive-main">568 CUP + 2 GB</div>
          </div>
        </div>

        <div class="card-body">
          <div class="benefits-row">
            <div class="benefit">
              <strong>568</strong>
              CUP
            </div>
            <div class="benefit">
              <strong>2 GB</strong>
              Datos
            </div>
            <div class="benefit">
              <strong>60</strong>
              Min
            </div>
            <div class="benefit">
              <strong>80</strong>
              SMS
            </div>
          </div>
          <div class="extra-info">
            Ideal para uso mixto de llamadas, datos y SMS.
          </div>
          <div class="validity">
            Validez estándar según condiciones de CUBACEL.
          </div>
        </div>

        <div class="card-footer">
          <div class="fees">
            Tasas e impuestos incluidos.
          </div>
          <button class="cta" data-product-id="cubacel-10">Entrar para comprar</button>
        </div>
      </article>

      <!-- OFERTA 2 -->
      <article class="card card--gradient">
        <div class="card-header">
          <span class="badge promo">Promo especial</span>
          <span class="tag-operator">CUBACEL · Cuba</span>
        </div>

        <div class="card-main">
          <div class="price-block">
            <div class="price">20,84 €</div>
            <div class="price-label">Precio final</div>
          </div>
          <div class="receive-block">
            <div class="receive-label">Recibe</div>
            <div class="receive-main">500 CUP + 4 GB</div>
          </div>
        </div>

        <div class="card-body">
          <div class="benefits-row">
            <div class="benefit">
              <strong>500</strong>
              CUP
            </div>
            <div class="benefit">
              <strong>4 GB</strong>
              Datos
            </div>
            <div class="benefit">
              <strong>75</strong>
              Min
            </div>
            <div class="benefit">
              <strong>80</strong>
              SMS
            </div>
          </div>
          <div class="extra-info">
            Recarga promocional con datos extra y minutos.
          </div>
          <div class="validity">
            Vigencia estimada: 35 días desde la activación.
          </div>
        </div>

        <div class="card-footer">
          <div class="fees">
            Oferta sujeta a calendario de promociones.
          </div>
          <button class="cta" data-product-id="cubacel-20">Entrar para comprar</button>
        </div>
      </article>

      <!-- OFERTA 3 -->
      <article class="card card--gradient">
        <div class="card-header">
          <span class="badge promo">Promo limitada</span>
          <span class="tag-operator">CUBACEL · Cuba</span>
        </div>

        <div class="card-main">
          <div class="price-block">
            <div class="price">25,01 €</div>
            <div class="price-label">Precio final</div>
          </div>
          <div class="receive-block">
            <div class="receive-label">Recibe</div>
            <div class="receive-main">700 CUP + 4 GB LTE</div>
          </div>
        </div>

        <div class="card-body">
          <div class="benefits-row">
            <div class="benefit">
              <strong>700</strong>
              CUP
            </div>
            <div class="benefit">
              <strong>4 GB</strong>
              LTE
            </div>
            <div class="benefit">
              <strong>60</strong>
              Min
            </div>
            <div class="benefit">
              <strong>—</strong>
              Extra
            </div>
          </div>
          <div class="extra-info">
            Pensada para uso intensivo de datos y llamadas.
          </div>
          <div class="validity">
            Vigencia estimada: 7 días desde la activación.
          </div>
        </div>

        <div class="card-footer">
          <div class="fees">
            Tasas incluidas. Oferta de corta duración.
          </div>
          <button class="cta" data-product-id="cubacel-25">Entrar para comprar</button>
        </div>
      </article>

    </section>

    <!-- TARJETAS NAUTA -->
    <section class="cards cards-nauta" style="display:none;">

      <!-- NAUTA 1 -->
      <article class="card card--gradient">
        <div class="card-header">
          <span class="badge">Recarga NAUTA</span>
          <span class="tag-operator">NAUTA · Cuba</span>
        </div>

        <div class="card-main">
          <div class="price-block">
            <div class="price">10,00 €</div>
            <div class="price-label">Precio final</div>
          </div>
          <div class="receive-block">
            <div class="receive-label">Recibe</div>
            <div class="receive-main">Saldo NAUTA equivalente</div>
          </div>
        </div>

        <div class="card-body">
          <div class="extra-info">
            Recarga básica para navegación NAUTA nacional e internacional.
          </div>
          <div class="validity">
            Vigencia según condiciones de NAUTA.
          </div>
        </div>

        <div class="card-footer">
          <div class="fees">
            Tasas e impuestos incluidos.
          </div>
          <button class="cta" data-product-id="nauta-10">Entrar para comprar</button>
        </div>
      </article>

      <!-- NAUTA 2 -->
      <article class="card card--gradient">
        <div class="card-header">
          <span class="badge promo">Pack NAUTA</span>
          <span class="tag-operator">NAUTA · Cuba</span>
        </div>

        <div class="card-main">
          <div class="price-block">
            <div class="price">20,00 €</div>
            <div class="price-label">Precio final</div>
          </div>
          <div class="receive-block">
            <div class="receive-label">Recibe</div>
            <div class="receive-main">Saldo NAUTA ampliado</div>
          </div>
        </div>

        <div class="card-body">
          <div class="extra-info">
            Ideal para usuarios que se conectan con frecuencia desde zonas WiFi.
          </div>
          <div class="validity">
            Vigencia según condiciones de NAUTA.
          </div>
        </div>

        <div class="card-footer">
          <div class="fees">
            Tasas incluidas. Oferta sujeta a cambios.
          </div>
          <button class="cta" data-product-id="nauta-20">Entrar para comprar</button>
        </div>
      </article>

    </section>

    </div>

    <div class="legal-links" style="text-align:center;margin-top:12px;">
      <small>
        <a href="terminos.html">Términos</a> ·
        <a href="privacidad.html">Privacidad</a> ·
        <a href="reembolsos.html">Reembolsos</a> ·
        <a href="mailto:recargaspacubaapp@gmail.com">Soporte</a>
      </small>
    </div>

  </main>

  <!-- ✅ MODAL RECARGA -->
  <div id="modal-bg-recarga" class="modal-bg-recarga">
    <div class="modal-recarga">
      <div class="modal-titulo">Confirma tu recarga</div>
      <div id="modal-detalle-cobro" class="modal-linea"></div>
      <div id="modal-detalle-recibe" class="modal-linea" style="margin-bottom:8px;"></div>

      <div class="input-prefijo">
        <span class="prefijo">+53</span>
        <input id="modal-numero" type="tel" inputmode="numeric" maxlength="8" placeholder="Número del móvil" />
      </div>

      <div class="input-prefijo">
        <span class="prefijo">+53</span>
        <input id="modal-numero2" type="tel" inputmode="numeric" maxlength="8" placeholder="Repite el número" />
      </div>

      <!-- ✅ NUEVO: SELECTOR VISUAL DE NÚMEROS RECIENTES -->
      <div id="modal-recientes" class="modal-recientes" style="display:none;">
        <div class="modal-recientes-titulo">Últimos números usados</div>
        <div id="modal-recientes-lista" class="modal-recientes-lista"></div>
      </div>

      <div class="modal-aviso">
        Verifica el número, las recargas no se pueden revertir.
      </div>

      <button id="btnRealizarRecarga">Realizar recarga</button>
    </div>
  </div>

  <!-- Barra inferior unificada -->
  <nav class="app-nav">
    <div class="nav-inner">
      <a href="recargar.html" class="nav-btn active">
        <span>⚡</span>
        <div>Recargar</div>
      </a>
      <a href="historial.html" class="nav-btn">
        <span>🕑</span>
        <div>Historial</div>
      </a>
      <a href="cuenta.html" class="nav-btn">
        <span>👤</span>
        <div>Cuenta</div>
      </a>
    </div>
  </nav>

  <!-- ✅ Data local centralizada + tabla de productos -->
  <script src="js/products.js"></script>
  <script src="js/userData.js"></script>
  <script src="js/validators.js"></script>

  <!-- ✅ Script anti-flash + tabs + modal + FASE 2 + ID + EMAIL + RECIENTES + CONTROL SESIÓN + UserData -->
  <script>
    window.addEventListener("load", () => {
      // Anti-flash
      document.documentElement.classList.add("loaded");

      // ✅ Control de sesión: si no hay usuario logueado, volver al login
      const usuarioSesion = localStorage.getItem("usuario");
      if (!usuarioSesion) {
        window.location.href = "index.html";
        return;
      }

      // ✅ Inicializar EmailJS
      if (typeof emailjs !== "undefined") {
        emailjs.init("flObIaDu0VCKDBP7i");
      }

      const datosUsuario = JSON.parse(localStorage.getItem("usuarioRegistrado") || "{}");

      // =========================
      // SISTEMA DE SALDO / HISTORIAL CENTRALIZADO EN UserData
      // =========================
      if (!window.UserData) {
        console.warn("UserData no disponible; usando fallback mínimo.");
      }

      function getSaldo() {
        if (window.UserData && typeof window.UserData.getSaldo === "function") {
          return window.UserData.getSaldo();
        }
        const raw = localStorage.getItem("rpc_saldo");
        const n = parseFloat(raw);
        return isNaN(n) ? 0 : n;
      }

      function setSaldo(nuevoSaldo) {
        if (window.UserData && typeof window.UserData.setSaldo === "function") {
          window.UserData.setSaldo(nuevoSaldo);
        } else {
          const num = Number(nuevoSaldo) || 0;
          localStorage.setItem("rpc_saldo", num.toFixed(2));
        }
      }

      function registrarRecargaEnHistorial(payload) {
        if (window.UserData && typeof window.UserData.addMovimientoRecarga === "function") {
          // Estructura estándar para el motor de monedas
          return window.UserData.addMovimientoRecarga(payload);
        }

        // Fallback por si falla UserData
        const raw = localStorage.getItem("rpc_historial") || "[]";
        let lista;
        try {
          lista = JSON.parse(raw);
          if (!Array.isArray(lista)) lista = [];
        } catch (e) {
          lista = [];
        }

        const item = {
          fecha: new Date().toISOString(),
          tipo: "recarga",
          ...payload
        };

        lista.unshift(item);
        localStorage.setItem("rpc_historial", JSON.stringify(lista));
        return item;
      }

      function recalcularMonedas() {
        if (window.UserData && typeof window.UserData.recalcularMonedas === "function") {
          return window.UserData.recalcularMonedas();
        }
        return 0;
      }

      const validators = (window.Validators && typeof window.Validators === "object") ? window.Validators : {};
      const validarRecargaEntrada = typeof validators.validarRecargaEntrada === "function"
        ? validators.validarRecargaEntrada
        : null;
      // ✅ Capa de negocio de recarga (preparada para futuro backend)
      async function procesarRecarga({ numero, importe, beneficio, operador, productoId }) {
        const saldoActual = getSaldo();

        if (saldoActual < importe) {
          return {
            success: false,
            reason: "SALDO_INSUFICIENTE",
            message: "Saldo insuficiente. Agrega saldo primero."
          };
        }

        const nuevoSaldo = saldoActual - importe;
        setSaldo(nuevoSaldo);

        const idConfirmacion = "RPC-" + Math.random().toString(36).substr(2, 6).toUpperCase();

        // Registrar en historial usando la capa centralizada
        const movimiento = registrarRecargaEnHistorial({
          importe,
          numero,
          operador: operador || "",
          productoId: productoId || "",
          descripcion: beneficio || "",
          extra: {
            beneficio: beneficio || "",
            estado: "OK",
            id: idConfirmacion
          }
        });

        // Recalcular monedas después de la recarga
        recalcularMonedas();

        return {
          success: true,
          idConfirmacion,
          movimiento,
          nuevoSaldo
        };
      }

      // =========================
      // NÚMEROS RECIENTES
      // =========================
      function getNumerosRecientes() {
        return JSON.parse(localStorage.getItem("rpc_numeros_recientes") || "[]");
      }

      function guardarNumeroReciente(num) {
        if (!num) return;
        let lista = getNumerosRecientes().filter(n => n !== num);
        lista.unshift(num);
        if (lista.length > 5) {
          lista = lista.slice(0, 5);
        }
        localStorage.setItem("rpc_numeros_recientes", JSON.stringify(lista));
      }

      function renderNumerosRecientes() {
        const contenedor = document.getElementById("modal-recientes");
        const listaEl = document.getElementById("modal-recientes-lista");
        const inputNum1 = document.getElementById("modal-numero");
        const inputNum2 = document.getElementById("modal-numero2");

        if (!contenedor || !listaEl || !inputNum1 || !inputNum2) return;

        const numeros = getNumerosRecientes();
        listaEl.innerHTML = "";

        if (!numeros.length) {
          contenedor.style.display = "none";
          return;
        }

        numeros.forEach(num => {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "modal-recientes-item";
          btn.textContent = num;
          btn.addEventListener("click", () => {
            inputNum1.value = num;
            inputNum2.value = num;
          });
          listaEl.appendChild(btn);
        });

        contenedor.style.display = "block";
      }

      // Tabs Cubacel / Nauta
      const tabs = document.querySelectorAll(".tabs .tab");
      const cubacel = document.querySelector(".cards-cubacel");
      const nauta = document.querySelector(".cards-nauta");

      if (tabs.length === 2 && cubacel && nauta) {
        const tabCubacel = tabs[0];
        const tabNauta = tabs[1];

        tabCubacel.addEventListener("click", () => {
          tabCubacel.classList.add("active");
          tabNauta.classList.remove("active");
          cubacel.style.display = "flex";
          nauta.style.display = "none";
        });

        tabNauta.addEventListener("click", () => {
          tabNauta.classList.add("active");
          tabCubacel.classList.remove("active");
          cubacel.style.display = "none";
          nauta.style.display = "flex";
        });
      }

      // Modal Recarga
      const modalBg = document.getElementById("modal-bg-recarga");
      const modalCobro = document.getElementById("modal-detalle-cobro");
      const modalRecibe = document.getElementById("modal-detalle-recibe");
      const inputNum1 = document.getElementById("modal-numero");
      const inputNum2 = document.getElementById("modal-numero2");
      const btnRealizar = document.getElementById("btnRealizarRecarga");

      let precioActual = 0;
      let beneficioActual = "";
      let operadorActual = "";
      let productoActual = null;

      if (modalBg && modalCobro && modalRecibe && inputNum1 && inputNum2 && btnRealizar) {
        const botonesCompra = document.querySelectorAll(".card .cta");

        botonesCompra.forEach((btn) => {
          btn.addEventListener("click", () => {
            const productId = btn.getAttribute("data-product-id");
            productoActual = null;
            precioActual = 0;
            beneficioActual = "";
            operadorActual = "";

            let precioTxt = "";
            let recibeTxt = "";
            let operadorTxt = "";

            if (productId && window.Products && typeof window.Products.getById === "function") {
              const producto = window.Products.getById(productId);
              if (!producto) {
                showToastError("No se encontró la oferta seleccionada. Inténtalo de nuevo.");
                return;
              }

              productoActual = producto;
              precioActual = Number(producto.importe) || 0;
              beneficioActual = producto.recibe || producto.descripcion || "";
              operadorActual = producto.operador || "";

              precioTxt = producto.precioTexto || (precioActual.toFixed(2) + " €");
              recibeTxt = producto.recibe || beneficioActual;
              operadorTxt = (producto.operador || "").toUpperCase();
            } else {
              showToastError("No se encontró el producto seleccionado. Inténtalo de nuevo.");
              return;
            }

            modalCobro.textContent = `Le cobraremos: ${precioTxt}`;
            modalRecibe.textContent = `El móvil recibe: ${recibeTxt}`;

            inputNum1.value = "";
            inputNum2.value = "";

            // ✅ Mostrar últimos números al abrir el modal
            renderNumerosRecientes();

            modalBg.style.display = "flex";
          });
        });

        // Cerrar modal al tocar fuera
        modalBg.addEventListener("click", (e) => {
          if (e.target === modalBg) {
            modalBg.style.display = "none";
          }
        });

        // Botón Realizar recarga (UserData + Email + recientes + VALIDACIÓN)
        btnRealizar.addEventListener("click", async () => {
          if (navigator.onLine === false) {
            if (typeof showToastError === 'function') {
              showToastError('No tienes conexión, no puedes realizar recargas ahora.');
            } else {
              alert('No tienes conexión, no puedes realizar recargas ahora.');
            }
            return;
          }

          const n1 = inputNum1.value || "";
          const n2 = inputNum2.value || "";

          if (typeof validarRecargaEntrada !== "function") {
            const msgValidacion = "No se pudo validar los datos. Inténtalo de nuevo.";
            if (typeof showToastError === "function") {
              showToastError(msgValidacion);
            } else {
              alert(msgValidacion);
            }
            return;
          }

          const validacion = validarRecargaEntrada({
            operador: operadorActual || "",
            numero1: n1,
            numero2: n2
          });

          if (!validacion.ok) {
            const errorMsg = validacion.error || "Datos inválidos. Revisa e inténtalo de nuevo.";
            if (typeof showToastError === "function") {
              showToastError(errorMsg);
            } else {
              alert(errorMsg);
            }
            return;
          }

          if (!precioActual || isNaN(precioActual)) {
            showToastError("No se pudo leer el precio de la recarga.");
            return;
          }

          const numeroFinal = validacion.sanitized && validacion.sanitized.numero ? validacion.sanitized.numero : null;

          const productoId = productoActual ? productoActual.id : null;

          // ? Usamos la capa de negocio centralizada
          const resultado = await procesarRecarga({
            numero: numeroFinal || "+53" + (n1 || "").replace(/\s+/g, "").replace(/^\+?53/, ""),
            importe: precioActual,
            beneficio: beneficioActual,
            operador: operadorActual || "",
            productoId
          });

          if (!resultado || !resultado.success) {
            const msg = resultado && resultado.message
              ? resultado.message
              : "No se pudo procesar la recarga. Inténtalo de nuevo.";
            showToastError(msg);
            return;
          }

          const { idConfirmacion, movimiento } = resultado;

          // ? Guardar número reciente
          if (numeroFinal) {
            guardarNumeroReciente(numeroFinal.replace(/^\+?53/, ""));
          }

          // ? Correo al cliente (EmailJS)
          if (datosUsuario && datosUsuario.email && typeof emailjs !== "undefined") {
            try {
              await emailjs.send("service_ryvafj3", "template_k5t8asf", {
                to_email: datosUsuario.email,
                numero: numeroFinal || movimiento.numero,
                importe: Number(movimiento.importe || precioActual).toFixed(2) + " €",
                beneficio: movimiento.beneficio || beneficioActual,
                fecha: movimiento.fecha || new Date().toLocaleString(),
                id_confirmacion: idConfirmacion
              });
            } catch (err) {
              console.error("Error enviando correo de recarga:", err);
            }
          }

          showToastSuccess("¡ Recarga registrada correctamente\nID: " + idConfirmacion);
          modalBg.style.display = "none";
        });
      }
    });
  </script>

  <!-- ✅ B1.3: onAuthStateChanged para sincronizar sesión con Firebase en RECARGAR -->
  <script type="module">
    import { auth, onAuthStateChanged } from "./js/firebase.js";

    onAuthStateChanged(auth, (user) => {
      if (!user) {
        // Si Firebase no tiene sesión, limpiamos y mandamos al login
        localStorage.removeItem("usuario");
        window.location.href = "index.html";
        return;
      }

      try {
        const raw = localStorage.getItem("usuarioRegistrado") || "{}";
        const datos = JSON.parse(raw);

        const nuevo = {
          ...datos,
          nombre: datos.nombre || user.displayName || "",
          email: (user.email || "").toLowerCase(),
          activo: true
        };

        localStorage.setItem("usuarioRegistrado", JSON.stringify(nuevo));
        localStorage.setItem("usuario", (user.email || "").toLowerCase());
      } catch (e) {
        console.error("Error sincronizando sesión en recargar:", e);
      }
    });
  </script>

  <script type="module" src="js/app.js"></script>
</body>
</html>





















